(self.webpackChunkplumier_docs=self.webpackChunkplumier_docs||[]).push([[542],{876:function(e,t,n){"use strict";n.d(t,{Zo:function(){return m},kt:function(){return c}});var r=n(2784);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),s=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,p=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),u=s(n),c=a,k=u["".concat(p,".").concat(c)]||u[c]||d[c]||l;return n?r.createElement(k,i(i({ref:t},m),{},{components:n})):r.createElement(k,i({ref:t},m))}));function c(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,i=new Array(l);i[0]=u;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var s=2;s<l;s++)i[s]=n[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},819:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},metadata:function(){return p},toc:function(){return s},default:function(){return d}});var r=n(7560),a=n(8283),l=(n(2784),n(876)),i=["components"],o={id:"generic-controller",title:"Generic Controller"},p={unversionedId:"generic-controller",id:"generic-controller",isDocsHomePage:!1,title:"Generic Controller",description:"Generic controller is a common Plumier controller with generic type signature, it take advantage of inheritance to possibly serve CRUD API based on ORM entity.",source:"@site/docs/Generic-Controller.md",sourceDirName:".",slug:"/generic-controller",permalink:"/generic-controller",editUrl:"https://github.com/plumier/plumier/edit/master/docs/docusaurus/docs/Generic-Controller.md",version:"current",frontMatter:{id:"generic-controller",title:"Generic Controller"},sidebar:"overview",previous:{title:"Security",permalink:"/security"},next:{title:"TypeORM Helper",permalink:"/typeorm-helper"}},s=[{value:"Enable Functionality",id:"enable-functionality",children:[]},{value:"Mark Entity Handled by Generic Controller",id:"mark-entity-handled-by-generic-controller",children:[]},{value:"Getting and Saving Simple Relation",id:"getting-and-saving-simple-relation",children:[]},{value:"Getting and Saving Array Relation",id:"getting-and-saving-array-relation",children:[]},{value:"Inverse Property Population",id:"inverse-property-population",children:[]},{value:"Apply Multiple Decorators",id:"apply-multiple-decorators",children:[]},{value:"Filters",id:"filters",children:[]},{value:"Delete Column",id:"delete-column",children:[]},{value:"Query Strings",id:"query-strings",children:[]},{value:"Custom Path Name",id:"custom-path-name",children:[]},{value:"Control Access To The Entity Properties",id:"control-access-to-the-entity-properties",children:[]},{value:"Control Access To The Generated Routes",id:"control-access-to-the-generated-routes",children:[]},{value:"Ignore Some Routes",id:"ignore-some-routes",children:[]},{value:"Transform Response",id:"transform-response",children:[]},{value:"Custom Query",id:"custom-query",children:[]},{value:"Entity Authorization Policy",id:"entity-authorization-policy",children:[]},{value:"Request Hook",id:"request-hook",children:[]},{value:"Use Custom Generic Controller",id:"use-custom-generic-controller",children:[]}],m={toc:s};function d(e){var t=e.components,n=(0,a.Z)(e,i);return(0,l.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"Generic controller is a common Plumier controller with generic type signature, it take advantage of inheritance to possibly serve CRUD API based on ORM entity. "),(0,l.kt)("h2",{id:"enable-functionality"},"Enable Functionality"),(0,l.kt)("p",null,"Generic controller supported TypeORM and Mongoose (with Plumier mongoose helper) entities. Enable the generic controller by installing the ",(0,l.kt)("inlineCode",{parentName:"p"},"TypeORMFacility")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"MongooseFacility")," on the Plumier application. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{6}","{6}":!0},'import Plumier, { WebApiFacility } from "plumier"\nimport { TypeORMFacility } from "@plumier/typeorm"\n\nnew Plumier()\n    .set(new WebApiFacility())\n    .set(new TypeORMFacility())\n')),(0,l.kt)("p",null,"Or if you are using mongoose helper like below"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{6}","{6}":!0},'import Plumier, { WebApiFacility } from "plumier"\nimport { MongooseFacility } from "@plumier/mongoose"\n\nnew Plumier()\n    .set(new WebApiFacility())\n    .set(new MongooseFacility())\n')),(0,l.kt)("p",null,"Above facilities is a common facility used if you are using TypeORM or Mongoose with Plumier. In context of generic controller above facilities will normalize entities to make it ready used by generic controller helpers. "),(0,l.kt)("h2",{id:"mark-entity-handled-by-generic-controller"},"Mark Entity Handled by Generic Controller"),(0,l.kt)("p",null,"After installing facility above you need to mark specific entity that will be generated into CRUD API with ",(0,l.kt)("inlineCode",{parentName:"p"},"@genericController()")," like below: "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{4}","{4}":!0},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route } from "plumier"\n\n@genericController()\n@Entity()\nclass User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    email: string\n\n    @Column()\n    name: string\n}\n')),(0,l.kt)("p",null,"Or if you using Mongoose helper "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{4}","{4}":!0},'import { collection } from "@plumier/mongoose"\nimport { route } from "plumier"\n\n@genericController()\n@collection()\nclass User {\n    constructor(\n        public id: string,\n        public email: string,\n        public name: string\n    ){}\n}\n')),(0,l.kt)("p",null,"Above code will generate six routes handled by generic controller implementation. "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users")),(0,l.kt)("td",{parentName:"tr",align:null},"Add new user")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id?select")),(0,l.kt)("td",{parentName:"tr",align:null},"Get user by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace user by ID (required validation used)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Modify user by ID (required validation ignored)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Delete user by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users")),(0,l.kt)("td",{parentName:"tr",align:null},"Get list of users with pagination, order, filter and projection")))),(0,l.kt)("p",null,"Its possible to create a generic controller using generic controller factory instead of using decorator, below code will result the same. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import { GenericController } from "@plumier/typeorm"\n// or if using mongoose \n// import { GenericController } from "@plumier/mongoose"\n\nconst UserController = GenericController(User)\n\n// Returned controller is a valid controller class, \n// so you can override its method like below\nexport class UserController extends GenericController(User) {\n    get(id:number) {\n        return super.get(id)\n    }\n}\n')),(0,l.kt)("p",null,"The factory receive controller builder factory configuration like below"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'export class UserController extends GenericController(User, c => {\n    c.mutators().authorize("Admin")\n})\n')),(0,l.kt)("h2",{id:"getting-and-saving-simple-relation"},"Getting and Saving Simple Relation"),(0,l.kt)("p",null,"Relational data with single value (one to one or many to one) by default will be populated on each request. For example if we have entity below: "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{24}","{24}":!0},"@genericController()\n@Entity()\nclass Address {\n    \n    /** other columns **/\n\n    @Column()\n    city:string\n\n    @Column()\n    address:string\n}\n\n@genericController()\n@Entity()\nclass User {\n    \n    /** other columns **/\n\n    @Column()\n    email:string\n\n    @OneToOne(x => Address)\n    address:Address\n}\n")),(0,l.kt)("p",null,"Above code generates 6 routes for each ",(0,l.kt)("inlineCode",{parentName:"p"},"/address")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"/users"),". ",(0,l.kt)("inlineCode",{parentName:"p"},"User")," entity contains relation property to ",(0,l.kt)("inlineCode",{parentName:"p"},"Address")," entity which is a one to one relation. Issuing ",(0,l.kt)("inlineCode",{parentName:"p"},"GET /users/:id")," will automatically populate the address, thus the response will be like below"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "email": "john.doe@gmail.com",\n    // full address object populated\n    "address": {\n        "city": "Badung",\n        "address": "Jl Surapati No. 19 Kuta" \n    }\n}\n')),(0,l.kt)("p",null,"While ",(0,l.kt)("inlineCode",{parentName:"p"},"GET /users/:id")," returns the full address object, saving address (POST, PUT, PATCH) only require the ID of the address like below "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'POST /users/123 \n\n{\n    "email": "john.doe@gmail.com",\n    "address": 456 //<-- address ID\n}\n')),(0,l.kt)("h2",{id:"getting-and-saving-array-relation"},"Getting and Saving Array Relation"),(0,l.kt)("p",null,"For array relation (one to many relation), Plumier provide a nested route to easily perform CRUD operation on child relation. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{9}","{9}":!0},"@Entity()\nclass User {\n    \n    /** other columns **/\n\n    @Column()\n    name:string\n\n    @genericController()\n    @OneToMany(x => Email, x => x.user)\n    emails:Email[]\n}\n\n@Entity()\nclass Email {\n    \n    /** other columns **/\n\n    @Column()\n    email:string\n\n    @Column()\n    description:string\n\n    @ManyToOne(x => User, x => x.emails)\n    user:User\n}\n")),(0,l.kt)("p",null,"Above code showing that we apply ",(0,l.kt)("inlineCode",{parentName:"p"},"@genericController()")," on the ",(0,l.kt)("inlineCode",{parentName:"p"},"User.emails")," relation. Using this setup will make Plumier generate a nested routes like below "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails")),(0,l.kt)("td",{parentName:"tr",align:null},"Add new user's email")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id?select")),(0,l.kt)("td",{parentName:"tr",align:null},"Get user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Modify user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Delete user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails")),(0,l.kt)("td",{parentName:"tr",align:null},"Get list of user's emails with paging, filter, order and projection")))),(0,l.kt)("p",null,"Its possible to create a nested generic controller using generic controller factory, below code will result the same. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import { GenericController } from "@plumier/typeorm"\n// or if using mongoose \n// import { GenericController } from "@plumier/mongoose"\n\nexport const UserEmailController = GenericController([User, "emails"])\n')),(0,l.kt)("p",null,"Its also possible to use many to one relation to generate nested routes, from previous example we can decorate the ",(0,l.kt)("inlineCode",{parentName:"p"},"Email.user")," property. This feature useful to create nested routes without explicit relation between parent-children, for example to reduce number of relation properties on parent entity. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{21}","{21}":!0},"@Entity()\nclass User {\n    \n    /** other columns **/\n\n    @Column()\n    name:string\n}\n\n@Entity()\nclass Email {\n    \n    /** other columns **/\n\n    @Column()\n    email:string\n\n    @Column()\n    description:string\n\n    @genericController()\n    @ManyToOne(x => User)\n    user:User\n}\n")),(0,l.kt)("p",null,"Instead of using one to many relation, we can decorate the ",(0,l.kt)("inlineCode",{parentName:"p"},"Email.user")," property and ignore ",(0,l.kt)("inlineCode",{parentName:"p"},"User.animals")," property. "),(0,l.kt)("p",null,"The generic controller factory for above feature also work the same as before, we specify tuple relation ",(0,l.kt)("inlineCode",{parentName:"p"},"Animal")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"user")," as the parameter of the generic controller factory"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import { GenericController } from "@plumier/typeorm"\n// or if using mongoose \n// import { GenericController } from "@plumier/mongoose"\n\nexport const UserEmailController = GenericController([Animal, "user"])\n')),(0,l.kt)("h2",{id:"inverse-property-population"},"Inverse Property Population"),(0,l.kt)("p",null,"If you are defined your one to many relation ORM configuration with inverse property, Generic controller will taking care of populating its value automatically. For example if you have ORM configuration like below. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{7}","{7}":!0},"@Entity()\nclass User {\n    \n    /** other columns **/\n\n    @genericController()\n    @OneToMany(x => Email, x => x.user)\n    emails:Email[]\n}\n\n@Entity()\nclass Email {\n    \n    /** other columns **/\n\n    @ManyToOne(x => User, x => x.emails)\n    user:User\n}\n")),(0,l.kt)("p",null,"Or if you are using mongoose helper like below"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{7}","{7}":!0},'@collection()\nclass User {\n    \n    /** other columns **/\n\n    @genericController()\n    @collection.ref(x => [Email], "user")\n    emails:Email[]\n}\n\n@Entity()\nclass Email {\n    \n    /** other columns **/\n\n    @collection.ref(x => User)\n    user:User\n}\n')),(0,l.kt)("p",null,"You're defined inverse property ",(0,l.kt)("inlineCode",{parentName:"p"},"user")," on the one to many relation, it help Plumier to understand which property will automatically populated. So adding new email using ",(0,l.kt)("inlineCode",{parentName:"p"},"POST /users/{pid}/emails")," will make ",(0,l.kt)("inlineCode",{parentName:"p"},"user")," automatically populated with ",(0,l.kt)("inlineCode",{parentName:"p"},"pid")," value, without having to provided on request body."),(0,l.kt)("h2",{id:"apply-multiple-decorators"},"Apply Multiple Decorators"),(0,l.kt)("p",null,"Its possible to apply multiple ",(0,l.kt)("inlineCode",{parentName:"p"},"@genericController()")," decorator on entity or entity relation, but the generated route must be unique or the route generator static check will shows errors. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'@genericController(c => c.setPath("user-emails/:id"))\n@genericController()\n@Entity()\nclass Email {\n    \n    /** other columns **/\n\n    @Column()\n    email:string\n\n    @Column()\n    description:string\n\n    @ManyToOne(x => User, x => x.emails)\n    user:User\n}\n')),(0,l.kt)("p",null,"Above will generates 12 routes like below "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/emails")),(0,l.kt)("td",{parentName:"tr",align:null},"Add new email")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/emails/:id?select")),(0,l.kt)("td",{parentName:"tr",align:null},"Get email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace email by ID (required validation used)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Modify email by ID (required validation ignored)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Delete email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/emails")),(0,l.kt)("td",{parentName:"tr",align:null},"Get list of emails with pagination, order, filter and projection")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-emails")),(0,l.kt)("td",{parentName:"tr",align:null},"Add new email")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-emails/:id?select")),(0,l.kt)("td",{parentName:"tr",align:null},"Get email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace email by ID (required validation used)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Modify email by ID (required validation ignored)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Delete email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-emails")),(0,l.kt)("td",{parentName:"tr",align:null},"Get list of emails with pagination, order, filter and projection")))),(0,l.kt)("h2",{id:"filters"},"Filters"),(0,l.kt)("p",null,"Generic controller provided filter query string to narrow API response. The query respects the ",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize.read()")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize.writeonly()"),". Its mean you will not able to query  "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{11,16}","{11,16}":!0},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route } from "plumier"\n\n@genericController()\n@Entity()\nclass User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    // name will be searchable by anyone (respect route authorization)\n    @Column()\n    name: string\n\n    // authorize email field to be search able by admin\n    @authorize.read("Admin")\n    @Column()\n    email: string\n}\n')),(0,l.kt)("p",null,"Using above code enabled us to query the response result using syntax string like below"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"# filter by email\nGET /users?filter=email=john.doe@gmail.com\n\n# or more readable using group\nGET /users?filter=(email=john.doe@gmail.com)\n\n# filter by name, will return all users name start with john\nGET /users?filter=(name='john'*)\n\n# combine both filter, will return with AND operator\nGET /users?filter=(email=john.doe@gmail.com and name=john)\n")),(0,l.kt)("p",null,"Several filter supported based on property data type, for more information see the ",(0,l.kt)("a",{parentName:"p",href:"/query-parser#query-language-specification"},"Query Language Specification")),(0,l.kt)("h2",{id:"delete-column"},"Delete Column"),(0,l.kt)("p",null,"By default when you perform ",(0,l.kt)("inlineCode",{parentName:"p"},"DELETE /users/{id}")," it will delete the user record permanently from the database, You can specify the delete flag by providing ",(0,l.kt)("inlineCode",{parentName:"p"},"@entity.deleteColumn()")," decorator above the flag property with ",(0,l.kt)("inlineCode",{parentName:"p"},"boolean")," datatype like below."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{10}","{10}":!0},'import { entity } from "plumier"\n\n@Entity()\nexport class User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    /** other properties **/\n\n    @entity.deleteColumn()\n    @Column({ default: false })\n    deleted: boolean\n}\n')),(0,l.kt)("p",null,"Using above code when you request ",(0,l.kt)("inlineCode",{parentName:"p"},"DELETE /users/{id}")," Plumier will set the ",(0,l.kt)("inlineCode",{parentName:"p"},"deleted")," property into ",(0,l.kt)("inlineCode",{parentName:"p"},"true")," automatically."),(0,l.kt)("h2",{id:"query-strings"},"Query Strings"),(0,l.kt)("p",null,"Both get by id and get list route has some extra query string to manipulate the response match your need. "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Query String"),(0,l.kt)("th",{parentName:"tr",align:null},"Example"),(0,l.kt)("th",{parentName:"tr",align:null},"Default"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"select")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"GET /users?select=name,email,dob")),(0,l.kt)("td",{parentName:"tr",align:null},"All properties"),(0,l.kt)("td",{parentName:"tr",align:null},"Select properties to include in JSON response")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"limit")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"GET /users?limit=20")),(0,l.kt)("td",{parentName:"tr",align:null},"50"),(0,l.kt)("td",{parentName:"tr",align:null},"Limit number of records returned in response")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"offset")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"GET /users?offset=3")),(0,l.kt)("td",{parentName:"tr",align:null},"0"),(0,l.kt)("td",{parentName:"tr",align:null},"Offset of the record set returned in response")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"filter")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"GET /users?filter=(name='john' and active=true)")),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Find records by property using exact comparison")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"order")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"GET /users?order=-createdAt,name")),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Order by properties, ",(0,l.kt)("inlineCode",{parentName:"td"},"-")," for descending order")))),(0,l.kt)("p",null,"Above query string supported by generic controller and nested generic controller. "),(0,l.kt)("h4",{id:"get-by-id"},"Get By ID"),(0,l.kt)("p",null,"Get by ID for generic controller and nested generic controller supported ",(0,l.kt)("inlineCode",{parentName:"p"},"select")," query string like below "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"GET /users/:id?select=name,email,dob\nGET /users/:pid/pets/:id?select=name,active,dob\n")),(0,l.kt)("h4",{id:"get-list"},"Get List"),(0,l.kt)("p",null,"Get list supported all the query string, it can be combined in single request "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"GET /users?select=name,email,dob&filter=(email='john.doe@gmail.com')&order=-createdAt,name&offset=5\nGET /users/:pid/pets/:id?select=name,dob&filter=(name=bingo)&order=-createdAt,name&offset=5\n")),(0,l.kt)("h2",{id:"custom-path-name"},"Custom Path Name"),(0,l.kt)("p",null,"Plumier provide a default route path name based on entity name (pluralized), you can specify a new path name by provide it on the ",(0,l.kt)("inlineCode",{parentName:"p"},"@genericController()")," parameter. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{4}","{4}":!0},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route } from "plumier"\n\n@genericController("user-data/:uid")\n@Entity()\nclass User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    email: string\n\n    @Column()\n    name: string\n}\n')),(0,l.kt)("p",null,"Above code showing that we specify custom path name ",(0,l.kt)("inlineCode",{parentName:"p"},"user-data/:uid"),", it will generate routes like below"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data")),(0,l.kt)("td",{parentName:"tr",align:null},"Add new user")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid")),(0,l.kt)("td",{parentName:"tr",align:null},"Get user by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace user by ID (required validation used)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid")),(0,l.kt)("td",{parentName:"tr",align:null},"Modify user by ID (required validation ignored)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid")),(0,l.kt)("td",{parentName:"tr",align:null},"Delete user by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data")),(0,l.kt)("td",{parentName:"tr",align:null},"Get list of users with paging, filter, order and projection")))),(0,l.kt)("p",null,"For nested generic controller you need to specify ID for parent and the child "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{6}","{6}":!0},'@Entity()\nclass User {\n    \n    /** other columns **/\n\n    @genericController("user-data/:uid/email-data/:eid")\n    @OneToMany(x => Email, x => x.user)\n    emails:Email[]\n}\n')),(0,l.kt)("p",null,"Above code will generate routes below "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid/email-data")),(0,l.kt)("td",{parentName:"tr",align:null},"Add new user's email")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid/email-data/:eid")),(0,l.kt)("td",{parentName:"tr",align:null},"Get user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid/email-data/:eid")),(0,l.kt)("td",{parentName:"tr",align:null},"Replace user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid/email-data/:eid")),(0,l.kt)("td",{parentName:"tr",align:null},"Modify user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid/email-data/:eid")),(0,l.kt)("td",{parentName:"tr",align:null},"Delete user's email by ID")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/user-data/:uid/email-data")),(0,l.kt)("td",{parentName:"tr",align:null},"Get list of user's email with paging, filter, order and projection")))),(0,l.kt)("h2",{id:"control-access-to-the-entity-properties"},"Control Access To The Entity Properties"),(0,l.kt)("p",null,"Plumier provide functionality to protect your data easily, you can use ",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize")," decorator to authorize user to write or read your entity property. "),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"Refer to ",(0,l.kt)("a",{parentName:"p",href:"/security"},"Security")," on how to setup user authorization on your Plumier application "))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{13,20}","{13,20}":!0},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route, authorize } from "plumier"\n\n@genericController()\n@Entity()\nclass User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    email: string\n\n    @authorize.writeonly()\n    @Column()\n    password: string\n\n    @Column()\n    name: string\n\n    @authorize.write("SuperAdmin", "Admin")\n    @Column()\n    role: "SuperAdmin" | "Admin" | "User"\n}\n')),(0,l.kt)("p",null,"Above code showing that we apply ",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize")," decorator on ",(0,l.kt)("inlineCode",{parentName:"p"},"password")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"role")," property which contains sensitive data. Using above configuration ",(0,l.kt)("inlineCode",{parentName:"p"},"password")," will not be visible on any response, and ",(0,l.kt)("inlineCode",{parentName:"p"},"role")," only can be set by ",(0,l.kt)("inlineCode",{parentName:"p"},"SuperAdmin")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"Admin"),". Below list of authorization you can use to protect property of the entity"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Decorator"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},'@authorize.route("SuperAdmin")')),(0,l.kt)("td",{parentName:"tr",align:null},"Protect route can be accessed by specific role (",(0,l.kt)("inlineCode",{parentName:"td"},"SuperAdmin"),")")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},'@authorize.write("SuperAdmin")')),(0,l.kt)("td",{parentName:"tr",align:null},"Protect property only can be write by specific role (",(0,l.kt)("inlineCode",{parentName:"td"},"SuperAdmin"),")")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},'@authorize.read("SuperAdmin")')),(0,l.kt)("td",{parentName:"tr",align:null},"Protect property only can be read by specific role (",(0,l.kt)("inlineCode",{parentName:"td"},"SuperAdmin"),")")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"@authorize.readonly()")),(0,l.kt)("td",{parentName:"tr",align:null},"Protect property only can be read and no other role can write it")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"@authorize.writeonly()")),(0,l.kt)("td",{parentName:"tr",align:null},"Protect property only can be write and no other role can read it")))),(0,l.kt)("h2",{id:"control-access-to-the-generated-routes"},"Control Access To The Generated Routes"),(0,l.kt)("p",null,"You can specify authorization into specific generated route by providing more configuration on the ",(0,l.kt)("inlineCode",{parentName:"p"},"@genericController()")," decorator."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{4}","{4}":!0},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route, authorize } from "plumier"\n\n@genericController(c => c.mutators().authorize("SuperAdmin", "Admin"))\n@Entity()\nclass User {\n    \n    /** properties / columns */\n\n}\n')),(0,l.kt)("p",null,"Above code showing that we apply authorization to the ",(0,l.kt)("inlineCode",{parentName:"p"},"mutators()")," http methods. ",(0,l.kt)("inlineCode",{parentName:"p"},"mutators()")," is a syntax sugar to specify generic controller actions handled the ",(0,l.kt)("inlineCode",{parentName:"p"},"POST"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"PUT"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"PATCH")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"DELETE"),". Using above configuration the result of the generated routes are like below"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Action"),(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Access"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"save")),(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"get")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Any user")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"replace")),(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"modify")),(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"delete")),(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"list")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users")),(0,l.kt)("td",{parentName:"tr",align:null},"Any user")))),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"If no authorization specified, the default authorization for generated route is ",(0,l.kt)("inlineCode",{parentName:"p"},"Authenticated")," means all authenticated user can access the route."))),(0,l.kt)("p",null,"For nested routes (one to many relation) you can define the same configuration like above."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{7}","{7}":!0},'@Entity()\nclass User {\n    \n    /** other columns **/\n\n    @genericController()\n    @authorize.route(c => c.mutators().authorize("SuperAdmin", "Admin"))\n    @OneToMany(x => Email, x => x.user)\n    emails:Email[]\n}\n')),(0,l.kt)("p",null,"Using above configuration the route access now is like below "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Action"),(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Access"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"save")),(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"get")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"Any user")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"replace")),(0,l.kt)("td",{parentName:"tr",align:null},"PUT"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"modify")),(0,l.kt)("td",{parentName:"tr",align:null},"PATCH"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"delete")),(0,l.kt)("td",{parentName:"tr",align:null},"DELETE"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id")),(0,l.kt)("td",{parentName:"tr",align:null},"SuperAdmin, Admin")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"list")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails")),(0,l.kt)("td",{parentName:"tr",align:null},"Any user")))),(0,l.kt)("h2",{id:"ignore-some-routes"},"Ignore Some Routes"),(0,l.kt)("p",null,"In some case you may want to hide specific route generated. You can use the ",(0,l.kt)("inlineCode",{parentName:"p"},"ignore()")," configuration to ignore specific methods"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{4-8}","{4-8}":!0},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route } from "plumier"\n\n@genericController(c => {\n    c.put().ignore()\n    c.patch().ignore()\n    c.delete().ignore()\n})\n@Entity()\nclass User {\n    \n    /** properties / columns */\n\n}\n')),(0,l.kt)("p",null,"Above code showing that we specify the method one by one instead of using ",(0,l.kt)("inlineCode",{parentName:"p"},"mutators()")," like the previous example. The result of the "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Action"),(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"save")),(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"get")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:id"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"list")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users"))))),(0,l.kt)("p",null,"It also can be applied on the entity relation (one to many) to ignore some nested routes like below "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{6-10}","{6-10}":!0},"@Entity()\nclass User {\n    \n    /** other columns **/\n\n    @genericController(c => {\n        c.put().ignore()\n        c.patch().ignore()\n        c.delete().ignore()\n    })\n    @OneToMany(x => Email, x => x.user)\n    emails:Email[]\n}\n")),(0,l.kt)("p",null,"Above code showing that we applied the ignore decorator on the entity relation, it will produce"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Action"),(0,l.kt)("th",{parentName:"tr",align:null},"Method"),(0,l.kt)("th",{parentName:"tr",align:null},"Route"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"save")),(0,l.kt)("td",{parentName:"tr",align:null},"POST"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"get")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails/:id"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"list")),(0,l.kt)("td",{parentName:"tr",align:null},"GET"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"/users/:pid/emails"))))),(0,l.kt)("h2",{id:"transform-response"},"Transform Response"),(0,l.kt)("p",null,"Its possible to transform the response result of the ",(0,l.kt)("inlineCode",{parentName:"p"},"GET")," method using ",(0,l.kt)("inlineCode",{parentName:"p"},"transformer()")," configuration. For example we have entities below"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},"@Entity()\nexport class Comment {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    message: string\n\n    @ManyToOne(x => User)\n    user: User\n\n    @ManyToOne(x => Todo)\n    todo:Todo\n}\n")),(0,l.kt)("p",null,"You may want the response of ",(0,l.kt)("inlineCode",{parentName:"p"},"GET /users")," only contains properties ",(0,l.kt)("inlineCode",{parentName:"p"},"id"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"message"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"userName")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"userPicture"),", which ",(0,l.kt)("inlineCode",{parentName:"p"},"userName")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"userPicture")," can be retrieved from ",(0,l.kt)("inlineCode",{parentName:"p"},"user")," property. "),(0,l.kt)("p",null,"First you need to create the model of the transformed entity."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},"export class CommentWithUser {\n    @noop()\n    id: number\n\n    @noop()\n    message: string\n\n    @noop()\n    userName: string\n\n    @noop()\n    userPicture: string\n}\n")),(0,l.kt)("p",null,"Then specify the transformation function using ",(0,l.kt)("inlineCode",{parentName:"p"},"transformer")," configuration "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},"@genericController(c => {\n    c.accessors().transformer(CommentWithUser, x => {\n        return {\n            id: x.id,\n            message: x.message,\n            userName: x.user.name,\n            userPicture: x.user.picture\n        }\n    })\n})\n@Entity()\nexport class Comment {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    message: string\n\n    @ManyToOne(x => User)\n    user: User\n\n    @ManyToOne(x => Todo)\n    todo:Todo\n}\n")),(0,l.kt)("p",null,"Above code showing that we specify the ",(0,l.kt)("inlineCode",{parentName:"p"},"transformer")," configuration, the first parameter is the target model then the second parameter is the transformation function. "),(0,l.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"When using response transform, the ",(0,l.kt)("inlineCode",{parentName:"p"},"select")," query may still applied but the response will be based on what you returned in transform function."))),(0,l.kt)("h2",{id:"custom-query"},"Custom Query"),(0,l.kt)("p",null,"Unlike transform response, with custom query you provide a custom database query for ",(0,l.kt)("inlineCode",{parentName:"p"},"getOne")," and/or ",(0,l.kt)("inlineCode",{parentName:"p"},"getMany")," method to get different response result than the default generic controller query provided. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import { route } from "plumier"\nimport { Entity, Column, PrimaryGeneratedColumn } from "typeorm"\nimport { noop } from "@plumier/reflect"\n// for mongoose use import { transformFilter } from "@plumier/mongoose"\nimport { transformFilter } from "@plumier/typeorm"\n\n@genericController(c => {\n    // custom query for GET /users/:id\n    c.getOne().custom(UserDto, async ({ id }) => {\n        const repo = getManager().getRepository(User)\n        return repo.findOne(id, { select: ["email"] })\n    })\n    // custom query for GET /users\n    c.getMany().custom([UserDto], async ({ limit, offset, filter }) => {\n        const repo = getManager().getRepository(User)\n        const where = transformFilter(filter)\n        return repo.find({ take: limit, skip: offset, where, select: ["email"] })\n    })\n})\n@Entity()\nclass User {\n    @PrimaryGeneratedColumn()\n    id: number\n    @Column()\n    email: string\n    @Column()\n    name: string\n}\n// the response will be like this \nclass UserDto {\n    @noop()\n    email: string\n}\n')),(0,l.kt)("p",null,"Using above code you provide a custom query that will be used by the ",(0,l.kt)("inlineCode",{parentName:"p"},"GET /users/:id"),". To override query of ",(0,l.kt)("inlineCode",{parentName:"p"},"GET /users")," you can use the ",(0,l.kt)("inlineCode",{parentName:"p"},"getMany()")," method instead of ",(0,l.kt)("inlineCode",{parentName:"p"},"getOne()"),". "),(0,l.kt)("p",null,"Signature of the ",(0,l.kt)("inlineCode",{parentName:"p"},"custom")," query method is like below "),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"custom(responseType, queryCallback)")," "),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"responseType")," is the model used to generate schema of the response. This model used by Open API generator to generate response schema, and also used by response authorization. Important to note that the ",(0,l.kt)("inlineCode",{parentName:"li"},"@authorize.read()")," on the entity will not take effect if you use different model than the entity, you need to decorate the appropriate property accordingly. "),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"queryCallback")," is a function returned the database query, signature of the query callback is mostly the same for ",(0,l.kt)("inlineCode",{parentName:"li"},"getOne()")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"getMany()"),", except the first parameter object, see below.")),(0,l.kt)("p",null,"Query callback signature for ",(0,l.kt)("inlineCode",{parentName:"p"},"getOne()")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"getMany()")," is like below "),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"(param, ctx) => any")," "),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"param")," contains the action parameter such as ",(0,l.kt)("inlineCode",{parentName:"li"},"id"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"limit"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"offset")," etc. The parameter is differ between ",(0,l.kt)("inlineCode",{parentName:"li"},"getOne()")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"getMany()"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ctx")," is the request context")),(0,l.kt)("h2",{id:"entity-authorization-policy"},"Entity Authorization Policy"),(0,l.kt)("p",null,"Entity Authorization Policy (Entity Policy) is a custom ",(0,l.kt)("a",{parentName:"p",href:"/security#authorization"},"auth policy")," designed to secure entity data by ID. "),(0,l.kt)("p",null,"Entity policy requires unique combination between policy name and the entity type, the definition is like below."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},"entityPolicy(ENTITY_CLASS)\n    .register(POLICY_NAME, (auth:AuthorizationContext, id:any) => boolean)\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ENTITY_CLASS")," is the entity which authorization policy registered to."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"POLICY_NAME")," is the policy name, policy name may the same with other entity but must be unique when combined with entity class."),(0,l.kt)("li",{parentName:"ul"},"Authorization callback is where you put the authorization logic, return ",(0,l.kt)("inlineCode",{parentName:"li"},"true")," or ",(0,l.kt)("inlineCode",{parentName:"li"},"Promise<true>")," to allow otherwise ",(0,l.kt)("inlineCode",{parentName:"li"},"false")," to restrict.")),(0,l.kt)("p",null,"Since the internal process of entity policy is quite complex, its a lot easier to understand entity policy from its implementation. For example we created an entity policy named ",(0,l.kt)("inlineCode",{parentName:"p"},"ResourceOwner")," which means the current data is owned by the login user. Then its easy to understand that for entity ",(0,l.kt)("inlineCode",{parentName:"p"},"User"),", the logic of ",(0,l.kt)("inlineCode",{parentName:"p"},"ResourceOwner")," is when the provided ID by authorization callback is the same as the current login user ID like below. "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'// define policy for User entity\nentityPolicy(User)\n    // ResourceOwner is when current login user id is the same as current User id \n    .register("ResourceOwner", (auth, id) => auth.user?.userId === id)\n')),(0,l.kt)("p",null,"This policy then can be applied on the generic controller configuration builder, to secure specific route like below."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{2}","{2}":!0},'@genericController(c => {\n    c.delete().authorize("ResourceOwner")\n})\n@Entity()\nexport class User {\n    @PrimaryGeneratedColumn()\n    id:number\n\n    @Column()\n    email: string\n\n    @Column()\n    name: string\n}\n')),(0,l.kt)("p",null,"By using above configuration only the ",(0,l.kt)("inlineCode",{parentName:"p"},"ResourceOwner")," of the User entity allowed to access ",(0,l.kt)("inlineCode",{parentName:"p"},"DELETE /users/{id}")," route. By giving ",(0,l.kt)("inlineCode",{parentName:"p"},"DELETE /users/12345")," only user with user ID ",(0,l.kt)("inlineCode",{parentName:"p"},"12345")," allowed to access it. "),(0,l.kt)("p",null,"The policy also can be used to secure property using ",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize.read()")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize.write()")," like below."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{7}","{7}":!0},'@genericController()\n@Entity()\nexport class User {\n    @PrimaryGeneratedColumn()\n    id:number\n\n    @authorize.read("ResourceOwner")\n    @Column()\n    email: string\n\n    @Column()\n    name: string\n}\n')),(0,l.kt)("p",null,"Above configuration will make ",(0,l.kt)("inlineCode",{parentName:"p"},"email")," filed only visible (in response body) by the owner of user, this behavior applied when the ",(0,l.kt)("inlineCode",{parentName:"p"},"User")," entity used as child property. "),(0,l.kt)("h4",{id:"entity-policy-restriction"},"Entity Policy Restriction"),(0,l.kt)("p",null,"Since entity policy designed to secure resources by ID, its important to note that route authorization (defined with ",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize.route()")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"ActionBuilder.authorize()"),") and parameter authorization (",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize.write()"),") only works on route with entity ID specified."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Route"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"POST /users")),(0,l.kt)("td",{parentName:"tr",align:null},"Not allowed, since no ID specified")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"DELETE /users/{id}")),(0,l.kt)("td",{parentName:"tr",align:null},"Allowed, Callback called with ID of User entity")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"POST /users/{id}/logs")),(0,l.kt)("td",{parentName:"tr",align:null},"Allowed, Callback called with ID of User entity")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"DELETE /users/{id}/logs/{logId}")),(0,l.kt)("td",{parentName:"tr",align:null},"Allowed, Callback called with ID of Log entity")))),(0,l.kt)("p",null,"Important to note that response authorization (",(0,l.kt)("inlineCode",{parentName:"p"},"@authorize.read()"),") has no restriction, its mean it will always work on all routes."),(0,l.kt)("h2",{id:"request-hook"},"Request Hook"),(0,l.kt)("p",null,"Request hook enables entity to have a method contains piece of code that will be executed during request. Request hook has some simple rule"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"It executed before or after the entity saved into the database, use decorator ",(0,l.kt)("inlineCode",{parentName:"li"},"@preSave()")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"@postSave()")),(0,l.kt)("li",{parentName:"ul"},"It will be executed only on request with http method ",(0,l.kt)("inlineCode",{parentName:"li"},"POST"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"PUT"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"PATCH"),". By default it will execute on those three http methods except specified on the parameter."),(0,l.kt)("li",{parentName:"ul"},"It can be specified multiple request hooks on single entity"),(0,l.kt)("li",{parentName:"ul"},"It can have parameter with parameter binding"),(0,l.kt)("li",{parentName:"ul"},"It possible to bind ActionResult (execution result of the controller) on request hook ",(0,l.kt)("inlineCode",{parentName:"li"},"@postSave()"))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{20,26}","{20,26}":!0},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route, preSave } from "plumier"\nimport bcrypt from "bcrypt"\n\n@genericController()\n@Entity()\nclass User {\n    @PrimaryGeneratedColumn()\n    id: number\n\n    @Column()\n    email: string\n\n    @Column()\n    name: string\n\n    @Column()\n    password: string\n\n    @preSave()\n    async hashPassword(){\n        // executed before user saved\n        this.password = await bcrypt.hash(data.password, 10)\n    }\n\n    @postSave()\n    async sendConfirmationEmail(){\n        // executed after user saved\n        await mailer.sendTemplate("confirmation-email")\n    }\n}\n')),(0,l.kt)("p",null,"Above code will hash password before the entity saved into the database. Request hook has parameter binding feature, you can ",(0,l.kt)("inlineCode",{parentName:"p"},"@bind")," any request part into the hook parameter, it works exactly like common ",(0,l.kt)("a",{parentName:"p",href:"/controller#parameter-binding"},"Parameter Binding")," which also support name binding, model binding and decorator binding."),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"The ID of the current entity only accessible on ",(0,l.kt)("inlineCode",{parentName:"p"},"@postSave")," using ",(0,l.kt)("inlineCode",{parentName:"p"},"this.id"),", since on ",(0,l.kt)("inlineCode",{parentName:"p"},"@postSave()")," the entity is not saved yet to database."))),(0,l.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"Keep in mind that entity used for ",(0,l.kt)("inlineCode",{parentName:"p"},"@preSave()")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"@postSave()")," is different, means if you using state variable to share between ",(0,l.kt)("inlineCode",{parentName:"p"},"@preSave()")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"@postSave()")," its may not working like expected."))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route, preSave } from "plumier"\nimport bcrypt from "bcrypt"\n\n@genericController()\n@Entity()\nclass User {\n    \n    /** other properties **/\n\n    @preSave()\n    async hook(@bind.ctx() ctx:Context){\n        // ctx will contains context\n    }\n\n    @postSave()\n    async postHook(@bind.ctx() ctx:Context){\n         // ctx will contains context\n    }\n}\n')),(0,l.kt)("p",null,"Its possible to specify in which http method should the hook executed by specify http method on the request hook parameter"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Entity, PrimaryGeneratedColumn } from "typeorm"\nimport { route, preSave } from "plumier"\nimport bcrypt from "bcrypt"\n\n@genericController()\n@Entity()\nclass User {\n    \n    /** other properties **/\n\n    @preSave("put", "patch")\n    async hook(){\n        // this only executed on PUT and PATCH http method before entity saved\n    }\n\n    @postSave("put", "patch")\n    async postHook(){\n        // this only executed on PUT and PATCH http method after entity saved\n    }\n}\n')),(0,l.kt)("h2",{id:"use-custom-generic-controller"},"Use Custom Generic Controller"),(0,l.kt)("p",null,"When the default generic controller doesn't match your need, you can provide your own custom generic controllers. For example the default generic controller for ",(0,l.kt)("inlineCode",{parentName:"p"},"GET")," method doesn't contains count of the match records usually used for table pagination on UI side. You can override this function by provide a new generic controller inherited from your ORM/ODM helper: "),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Generic Controller"),(0,l.kt)("th",{parentName:"tr",align:null},"Package"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"TypeORMControllerGeneric<T, TID>")),(0,l.kt)("td",{parentName:"tr",align:null},"@plumier/typeorm"),(0,l.kt)("td",{parentName:"tr",align:null},"TypeORM generic controller implementation")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"TypeORMNestedControllerGeneric<P, T, PID, TID>")),(0,l.kt)("td",{parentName:"tr",align:null},"@plumier/typeorm"),(0,l.kt)("td",{parentName:"tr",align:null},"TypeORM One To Many generic controller implementation")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"MongooseControllerGeneric<T, TID>")),(0,l.kt)("td",{parentName:"tr",align:null},"@plumier/mongoose"),(0,l.kt)("td",{parentName:"tr",align:null},"Mongoose generic controller implementation")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"MongooseNestedControllerGeneric<P, T, PID, TID>")),(0,l.kt)("td",{parentName:"tr",align:null},"@plumier/mongoose"),(0,l.kt)("td",{parentName:"tr",align:null},"Mongoose One To Many generic controller implementation")))),(0,l.kt)("p",null,"First define the model represent the response schema returned by each controller using generic type like below "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import {generic, type, noop} from "@plumier/reflect"\n\n@generic.parameter("T")\nexport class Response<T> {\n    @type(["T"])\n    data: T[]\n    @noop()\n    count: number\n}\n')),(0,l.kt)("p",null,"Then create a new generic controller for both based on any of above generic controller like below "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import {TypeORMControllerGeneric, TypeORMNestedControllerGeneric} from "@plumier/typeorm"\n\nexport class CustomControllerGeneric<T, TID> extends TypeORMControllerGeneric<T, TID> {\n    @type(Response, "T")\n    async list(offset: number, limit: number, filter: any, select: SelectQuery, order: any, ctx: Context) {\n        const data = await super.list(offset, limit, filter, select, order, ctx)\n        const count = await this.repo.count(filter)\n        return { data, count } \n    }\n}\n\nexport class CustomNestedControllerGeneric<P, T, PID, TID> extends TypeORMNestedControllerGeneric<P, T, PID, TID>{\n    @type(Response, "T")\n    async list(pid: PID, offset: number, limit: number, filter: any, select: SelectQuery, order: any, ctx: Context) {\n        const data = await super.list(pid, offset, limit, filter, select, order, ctx)\n        const count = await this.repo.count(pid, filter)\n        return { data, count } \n    }\n}\n')),(0,l.kt)("p",null,"Using above code, we simply call the ",(0,l.kt)("inlineCode",{parentName:"p"},"super.list")," method and use the repository ",(0,l.kt)("inlineCode",{parentName:"p"},"count")," method to create the response match the ",(0,l.kt)("inlineCode",{parentName:"p"},"Response")," data structure."),(0,l.kt)("p",null,"Note that we define the return type of the method as ",(0,l.kt)("inlineCode",{parentName:"p"},'@type(Response, "T")'),", this means we specify that the ",(0,l.kt)("inlineCode",{parentName:"p"},"Response.data")," property is of type of ",(0,l.kt)("inlineCode",{parentName:"p"},"T")," of the generic controller."),(0,l.kt)("p",null,"Next, we need to register above custom generic controller on the Plumier application like below "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"{6}","{6}":!0},"new Plumier()\n    .set(new WebApiFacility())\n    .set(new TypeORMFacility())\n    // Make sure to register the controller under the `TypeORMFacility` or `MongooseFacility`. \n    .set({\n        genericController: [CustomControllerGeneric, CustomNestedControllerGeneric]\n    })\n")),(0,l.kt)("p",null,"Keep in mind that the controller created using generic controller factory ",(0,l.kt)("inlineCode",{parentName:"p"},"GenericController(Entity)")," or ",(0,l.kt)("inlineCode",{parentName:"p"},'GenericController([Entity, "children"])')," will keep using the default generic controllers, to solve the issue you can use the generic controller factory factory like below."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},'import { createGenericControllerTypeORM } from "@plumier/typeorm"\n// for mongoose use below import\n// import { createGenericControllerMongoose } from "@plumier/mongoose"\n\nexport const CustomGenericController = createGenericControllerTypeORM([CustomControllerGeneric, CustomNestedControllerGeneric])\n')),(0,l.kt)("p",null,"With above code we created a new generic controller factory which based on our custom generic controllers. Export the factory and use it anywhere on your code like usual generic controller factory."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},"const UsersController = CustomGenericController(User)\n// or\nclass UsersController extends CustomGenericController(User) { }\n")))}d.isMDXComponent=!0}}]);