(self.webpackChunkplumier_docs=self.webpackChunkplumier_docs||[]).push([[705],{876:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return c}});var a=n(2784);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=d(n),c=r,h=u["".concat(s,".").concat(c)]||u[c]||m[c]||o;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var d=2;d<o;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9301:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return i},metadata:function(){return l},toc:function(){return s},default:function(){return p}});var a=n(7560),r=n(8283),o=(n(2784),n(876)),i={id:"extend",title:"Overview"},l={unversionedId:"extend",id:"extend",isDocsHomePage:!1,title:"Overview",description:"This documentation covers most of advanced Plumier functionalities. By reading this documentation you will be able to extends the framework functionalities to give plumier a new ability.",source:"@site/docs/Extend.md",sourceDirName:".",slug:"/extend",permalink:"/extend",editUrl:"https://github.com/plumier/plumier/edit/master/docs/docusaurus/docs/Extend.md",version:"current",frontMatter:{id:"extend",title:"Overview"},sidebar:"overview",previous:{title:"Default Environment Variable",permalink:"/default-environment-variable"},next:{title:"Reflection Fundamentals",permalink:"/reflection-basic"}},s=[{value:"Plumier Middleware in a Nutshell",id:"plumier-middleware-in-a-nutshell",children:[]},{value:"Context",id:"context",children:[]},{value:"Application Lifecycle",id:"application-lifecycle",children:[]},{value:"Metaprogramming",id:"metaprogramming",children:[]},{value:"Custom Middleware",id:"custom-middleware",children:[{value:"Example Global Middleware",id:"example-global-middleware",children:[]},{value:"Example Controller/Method Middleware",id:"example-controllermethod-middleware",children:[]}]},{value:"Custom Parameter Binding",id:"custom-parameter-binding",children:[]},{value:"Custom Validator",id:"custom-validator",children:[]},{value:"Custom Authorization",id:"custom-authorization",children:[]}],d={toc:s};function p(e){var t=e.components,i=(0,r.Z)(e,["components"]);return(0,o.kt)("wrapper",(0,a.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"This documentation covers most of advanced Plumier functionalities. By reading this documentation you will be able to extends the framework functionalities to give plumier a new ability."),(0,o.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"By reading this documentation assume that you are already familiar with basic Plumier functionalities such as parameter binding, routing, type conversion etc."))),(0,o.kt)("p",null,"Plumier has some built-in functionalities such as validators, parameter binders, authorizer etc. If those functionalities doesn't fit your needs, you can extends Plumier capability by providing your own custom extension. Plumier provided some interfaces contract to easily extend its capability."),(0,o.kt)("p",null,"There are some knowledge base you need to know to make a better understanding on how things work inside the framework before start creating custom extension."),(0,o.kt)("h2",{id:"plumier-middleware-in-a-nutshell"},"Plumier Middleware in a Nutshell"),(0,o.kt)("p",null,"The term of middleware in Plumier is the same as in other framework such as Express and Koa. All functionalities (validator, authorization, parameter binding etc) in Plumier are implementation of middleware. "),(0,o.kt)("p",null,"Unlike Express, Plumier middleware used a modern pipeline. Instead of using a chain of callback Plumier middleware used chain of promise (async/await) executed from one to another waiting the execution result of the next middleware. "),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Pipeline",src:n(5095).Z})),(0,o.kt)("p",null,"This pipeline has better execution control than Express, because the previous middleware free to await the next middleware execution or return a new ",(0,o.kt)("inlineCode",{parentName:"p"},"ActionResult")," immediately and stop the execution pipeline without touching the controller. "),(0,o.kt)("p",null,"This behavior very important for some functionalities such as Validation and Authorization where middleware can stop the pipeline execution immediately when some state doesn't match the preferred condition and returned error message immediately. "),(0,o.kt)("p",null,"This behavior also has better error handling because API programmer free to throw error anywhere inside middlewares or controllers because its guaranteed will be caught by the higher middleware."),(0,o.kt)("p",null,"Simplest custom middleware example is like below"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"class MyCustomMiddleware implements CustomMiddleware {\n    execute(inv:Invocation){\n        return inv.proceed()\n    }\n}\n")),(0,o.kt)("p",null,"Above code showing a simplest custom middleware it does nothing except execute the next middleware and pass the result into the higher middleware. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const myCustomMiddleware:CustomMiddlewareFunction = inv => inv.proceed()\n")),(0,o.kt)("p",null,"Above code is another version of middleware, its created using functional custom middleware, it has the same behavior with the previous example."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Invocation")," is an object represent the next process will be invoked by the middleware. It has ",(0,o.kt)("inlineCode",{parentName:"p"},"proceed()")," method used to execute the next process and returned the execution result ",(0,o.kt)("inlineCode",{parentName:"p"},"Promise<ActionResult>"),". Invocation has ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx")," property which is the Context useful to get current request information."),(0,o.kt)("h2",{id:"context"},"Context"),(0,o.kt)("p",null,"Context in Plumier (usually the variable named ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx"),") is derived from ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/koajs/koa/blob/master/docs/api/context.md"},"Koa context"),", it encapsulate ",(0,o.kt)("inlineCode",{parentName:"p"},"HttpRequest")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"HttpResponse")," object into a single object, it mostly used in every custom extension. "),(0,o.kt)("p",null,"Context can be accessed from inside controller using parameter binding ",(0,o.kt)("inlineCode",{parentName:"p"},"@bind.ctx()")," or from inside any custom extension. Even though Context has tons of properties, usually only a few will be used, here are list of most used properties: "),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.request.body")," the request body. Don't confuse with ",(0,o.kt)("inlineCode",{parentName:"li"},"ctx.body")," because its the response body. "),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.query")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"ctx.request.query")," the request query case insensitive. Can be access using ",(0,o.kt)("inlineCode",{parentName:"li"},"ctx.query.myQuery"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"ctx.query.MYQUERY"),", ",(0,o.kt)("inlineCode",{parentName:"li"},'ctx.query["myquery"]')," or ",(0,o.kt)("inlineCode",{parentName:"li"},'ctx.query["MYQUERY"]'),"  "),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.header")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"ctx.request.header")," the request header."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.cookies")," the cookie"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.state.user")," the current login user (JWT claim)"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.user")," the current login user (same as ",(0,o.kt)("inlineCode",{parentName:"li"},"ctx.state.user"),")"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.config")," the Plumier application configuration"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.routes")," array of all route information used by the route generator. "),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.route")," the current route information, contains metadata information of current controller or action handles the request. For request doesn't associated with controller the value will be ",(0,o.kt)("inlineCode",{parentName:"li"},"undefined"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.parameters")," array of value that will be bound to controller's method. The value arranged in a correct order match with methods parameter. This property only available on controller/method middleware")),(0,o.kt)("p",null,"For a complete reference about Context and its properties can be found in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/koajs/koa/blob/master/docs/api/context.md"},"Koa documentation"),". "),(0,o.kt)("h2",{id:"application-lifecycle"},"Application Lifecycle"),(0,o.kt)("p",null,"When an Http Request issued into Plumier application, the process goes through a series of processing steps categorized into three main process like picture below."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Lifecycle",src:n(5437).Z})),(0,o.kt)("p",null,"The execution process start from the left to right to pass the request that will be processed by controller and then returned back from right to left for the controller execution result that will be rendered into http response."),(0,o.kt)("p",null,"All the child process of the Middleware Pipeline is extensible by using custom extension with specific registration:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Custom global middleware middleware registered using Plumier application during the application bootstrap using ",(0,o.kt)("inlineCode",{parentName:"li"},"app.use()")," method."),(0,o.kt)("li",{parentName:"ol"},"Custom parameter binding registered on the appropriate parameter using ",(0,o.kt)("inlineCode",{parentName:"li"},"@bind.custom()")," decorator."),(0,o.kt)("li",{parentName:"ol"},"Custom validator registered on the appropriate parameter or domain model property using ",(0,o.kt)("inlineCode",{parentName:"li"},"@val.custom()")," decorator."),(0,o.kt)("li",{parentName:"ol"},"Custom authorization registered on appropriate controller, methods, parameter or domain model properties on deep nested property using ",(0,o.kt)("inlineCode",{parentName:"li"},"@authorize.custom()")," decorator."),(0,o.kt)("li",{parentName:"ol"},"Controller/method middleware register on controller or method using ",(0,o.kt)("inlineCode",{parentName:"li"},"@middleware.use()")," decorator. ")),(0,o.kt)("p",null,"Note that the execution order of the child process of the middleware pipeline is important. The execution start from left to right so global middleware has more control than the other process. "),(0,o.kt)("p",null,"The execution order also affect the ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx.parameters")," value which will only available after Parameter Binding process, so global middleware will not be able to access them. "),(0,o.kt)("h2",{id:"metaprogramming"},"Metaprogramming"),(0,o.kt)("p",null,"One of Plumier key feature is it provide metadata information for metaprogramming. This metadata information accessible from all custom extensions.  "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'const customMiddleware:CustomMiddlewareFunction = ({ metadata, proceed }) => {\n    if(metadata.controller.name === "AnimalController")\n        return proceed()\n    else \n        throw new HttpStatusError(404)\n}\n')),(0,o.kt)("p",null,"Request metadata is specialized class contains metadata of current request such as controller, action and action parameter useful for metaprogramming. It contains some properties: "),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"actionParams")," current action parameters metadata, used to access parameter value, name etc."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"controller")," current controller object graph, contains information about controller name, decorators, methods, constructor etc. "),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"action")," current action object graph, contains information about action name, parameters, decorators etc."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"current")," metadata information where the appropriate decorator applied, can be Class metadata, Method metadata, Property metadata or Parameter metadata. For global middleware the ",(0,o.kt)("inlineCode",{parentName:"li"},"current")," property will be ",(0,o.kt)("inlineCode",{parentName:"li"},"undefined"),".")),(0,o.kt)("p",null,"This request metadata usually accessible from ",(0,o.kt)("inlineCode",{parentName:"p"},"metadata")," property from ",(0,o.kt)("inlineCode",{parentName:"p"},"Invocation")," class, ",(0,o.kt)("inlineCode",{parentName:"p"},"ValidatorContext")," class, and ",(0,o.kt)("inlineCode",{parentName:"p"},"AuthorizerContext")," class."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// ValidatorContext\nconst customValidation: CustomValidatorFunction = (val, { metadata }) => { \n    // process metadata\n}\n\n// AuthorizerContext\nconst customAuthorizer: CustomAuthorizerFunction = ({ metadata, ctx }) => {\n    // process metadata\n}\n")),(0,o.kt)("h2",{id:"custom-middleware"},"Custom Middleware"),(0,o.kt)("p",null,"There are two kind custom middlewares: Global middleware and Controller/method middleware. Technically both are the same but there are some distinction between them: "),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.route")," accessible in both, but in global middleware the value is optional (can be ",(0,o.kt)("inlineCode",{parentName:"li"},"undefined"),"), because global middleware kept executed even the request doesn't has appropriate controller."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"ctx.parameters")," with cleansed value (converted/validated) only accessible from controller/method middleware"),(0,o.kt)("li",{parentName:"ol"},"Controller/method middleware will never touched when there are validation error or authorization error occur."),(0,o.kt)("li",{parentName:"ol"},"Global middleware derived from ",(0,o.kt)("inlineCode",{parentName:"li"},"CustomMiddleware")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"CustomMiddlewareFunction"),". Controller/action middleware derived from ",(0,o.kt)("inlineCode",{parentName:"li"},"CustomMiddleware<ActionContext>")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"CustomMiddlewareFunction<ActionContext>"),".")),(0,o.kt)("h3",{id:"example-global-middleware"},"Example Global Middleware"),(0,o.kt)("p",null,"Global middleware always executed on every request, this behavior can be used to create a virtual endpoint without having a controller that handle the request. For example we create the ",(0,o.kt)("inlineCode",{parentName:"p"},"/hello-world")," endpoint and returned a JSON. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'const sayHello:CustomMiddlewareFunction = async inv => {\n    if(inv.ctx.path.search(/^\\/hello-world/i) > -1)\n        return new ActionResult({ message: "Hello World" })\n    else \n        return inv.proceed()\n}\n')),(0,o.kt)("p",null,"Register the middleware from the Plumier application like below"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"new Plumier()\n    .set(new WebApiFacility())\n    .use(sayHello)\n")),(0,o.kt)("p",null,"Above code will handle the ",(0,o.kt)("inlineCode",{parentName:"p"},"/hello-world")," then return an ",(0,o.kt)("inlineCode",{parentName:"p"},"ActionResult")," immediately if the path match the criteria else the next invocation executed."),(0,o.kt)("h3",{id:"example-controllermethod-middleware"},"Example Controller/Method Middleware"),(0,o.kt)("p",null,"Controller/Method middleware has access to the ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx.route")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx.parameters"),". This property best used for programming. On this example will will create a logging middleware to print the controller name, method name, the parameters applied and the time used to complete the request. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'const metaLog:CustomMiddlewareFunction<ActionContext> = async inv => {\n    const start = new Date()\n    const result = await inv.proceed()\n    const time = (new Date().getTime() - start.getTime())/1000\n    console.log("Controller:", ctx.route.controller.name)\n    console.log("Method:", ctx.route.action.name)\n    console.log("Parameters:", ctx.parameters)\n    console.log("Execution Time:", time)\n    return result;\n}\n')),(0,o.kt)("p",null,"Register the middleware on top of Controller "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'@middleware.use(metaLog)\nclass AnimalsController {\n    @route.get(":id")\n    get(id:number) { }\n\n    @route.post("")\n    save(data:Animal){ }\n\n    @route.put(":id")\n    modify(id:number, data:Animal){ }\n}\n')),(0,o.kt)("p",null,"Above code showing that the middleware applied on the controller, its mean it will log the controller name, method name etc when all the three endpoints (",(0,o.kt)("inlineCode",{parentName:"p"},"GET /animals/:id")," ",(0,o.kt)("inlineCode",{parentName:"p"},"POST /animals")," ",(0,o.kt)("inlineCode",{parentName:"p"},"PUT /animals/:id"),") accessed. "),(0,o.kt)("h2",{id:"custom-parameter-binding"},"Custom Parameter Binding"),(0,o.kt)("p",null,"Custom parameter binding extends the parameter binding functionalities, signature of custom parameter binding is like below"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"type CustomBinderFunction = (ctx:Context) => any | Promise\n")),(0,o.kt)("p",null,"Custom parameter binder receive single parameter which of type Context and return the value that will be bound to the parameter. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'const authHeader:CustomBinderFunction = ctx => ctx.request.header.Authorization \n\nclass AnimalsController {\n    @route.get(":id")\n    get(id:number, @bind.custom(authHeader) auth:string) { }\n}\n')),(0,o.kt)("p",null,"Above code will bind the ",(0,o.kt)("inlineCode",{parentName:"p"},"auth")," parameter with the ",(0,o.kt)("inlineCode",{parentName:"p"},"Authorization")," header."),(0,o.kt)("h2",{id:"custom-validator"},"Custom Validator"),(0,o.kt)("p",null,"Custom validator extends Plumier validator functionalities. For example we want to create adult age restriction validation, the implementation simply like below"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'const isAdult:CustomValidatorFunction = val => {\n    if(parseInt(val) < 18)\n        return "Sorry you\'re not ready to view the content"\n}\n')),(0,o.kt)("p",null,"Custom validator can be applied on controller's method parameter or on domain property. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'@domain()\nclass LoginUser {\n    constructor(\n        public userId:number,\n        public role:string,\n        @val.custom(isAdult)\n        public age:number\n    ){}\n}\nclass PictureController {\n    @route.get()\n    adult(@bind.user() user:LoginUser) {\n        return response.file(__dirname, "path/of/adult_image.jpg")\n    }\n}\n')),(0,o.kt)("p",null,"Above code will restrict access to the ",(0,o.kt)("inlineCode",{parentName:"p"},"GET /picture/adult")," endpoint by validating the ",(0,o.kt)("inlineCode",{parentName:"p"},"age")," property of the current login user provided by the JWT token claim."),(0,o.kt)("p",null,"Refer to the ",(0,o.kt)("a",{parentName:"p",href:"/custom-validator"},"custom validator documentation")," for more info."),(0,o.kt)("h2",{id:"custom-authorization"},"Custom Authorization"),(0,o.kt)("p",null,"Custom authorization extends Plumier authorization functionalities. This custom extension useful when you want to secure an endpoint based on specific data. "),(0,o.kt)("p",null,"For example an online marketplace user free to create their own shop and assigned as the ",(0,o.kt)("inlineCode",{parentName:"p"},"ShopAdmin")," by default, further more they can assign another user as ",(0,o.kt)("inlineCode",{parentName:"p"},"Staff"),". "),(0,o.kt)("p",null,"Above logic is impossible when implemented using default Plumier authorization because user role is dynamic based on data. Here are example of the Shop controller. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'class ShopsController {\n    @route.post("")\n    save(data:Shop) { }\n\n    @route.get(":shopId")\n    get(shopId:number) { }\n\n    @route.put(":shopId")\n    modify(shopId:number, data:Shop) { }\n\n    @route.delete(":shopId")\n    delete(shopId:number) { }\n}\n')),(0,o.kt)("p",null,"The expected endpoint access is like below:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Endpoint"),(0,o.kt)("th",{parentName:"tr",align:null},"Authorize"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"POST    /shops")),(0,o.kt)("td",{parentName:"tr",align:null},"Authenticated"),(0,o.kt)("td",{parentName:"tr",align:null},"All login user can create new shop")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"GET     /shops/:shopId")),(0,o.kt)("td",{parentName:"tr",align:null},"Public"),(0,o.kt)("td",{parentName:"tr",align:null},"All user login or non login can show")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"PUT     /shops/:shopId")),(0,o.kt)("td",{parentName:"tr",align:null},"ShopAdmin, Staff"),(0,o.kt)("td",{parentName:"tr",align:null},"Only Admin and Staff of the shop (shopId) can modify")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"DELETE  /shops/:shopId")),(0,o.kt)("td",{parentName:"tr",align:null},"ShopAdmin"),(0,o.kt)("td",{parentName:"tr",align:null},"Only Shop Admin can delete the shop")))),(0,o.kt)("p",null,"Implementation of the custom authorizer is like below:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'function shopUser(...roles: ("ShopAdmin" | "Staff")[]) {\n    return authorize.custom({ ctx, user, metadata }) => {\n        //check if action/method handles the request has shopId parameter\n        //useful when this custom authorizer applied on wrong method\n        if (metadata.actionParams.hasName("shopId")) \n            throw new Error("Method handle the request doesn\'t have shopId parameter")\n        //get the value assigned for shopId parameter\n        const shopId = metadata.actionParams.get("shopId")\n        //get the current login userId\n        const userId = user.userId\n        //get the user role associated to the shop on the database\n        const shopUser = await ShopUserModel.findOne({ shopId, userId })\n        //check if the role match any of the authorized roles\n        return roles.some(x => x === shopUser?.role)\n    })\n}\n')),(0,o.kt)("p",null,"Above code showing that we create a custom authorizer by directly returned the ",(0,o.kt)("inlineCode",{parentName:"p"},"@authorize.custom()"),", its mean the ",(0,o.kt)("inlineCode",{parentName:"p"},"shopUser")," function is a custom decorator that can be applied on controller or method. "),(0,o.kt)("p",null,"Above authorizer reads the metadata information of current request to check wether the method has parameter named ",(0,o.kt)("inlineCode",{parentName:"p"},"shopId")," and extract the shopId value from the ",(0,o.kt)("inlineCode",{parentName:"p"},"metadata.actionParams"),". By using this trick this decorator can be reuse in any method has parameter named ",(0,o.kt)("inlineCode",{parentName:"p"},"shopId"),"."),(0,o.kt)("p",null,"Custom authorizer above can be applied easily on the previous controller."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'class ShopsController {\n    @route.post("")\n    save(data:Shop) { }\n\n    @authorize.public()\n    @route.get(":shopId")\n    get(shopId:number) { }\n\n    @shopUser("ShopAdmin", "Staff")\n    @route.put(":shopId")\n    modify(shopId:number, data:Shop) { }\n\n    @shopUser("ShopAdmin")\n    @route.delete(":shopId")\n    delete(shopId:number) { }\n}\n')),(0,o.kt)("p",null,"Code above showing that we applied our custom authorizer above ",(0,o.kt)("inlineCode",{parentName:"p"},"modify")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"delete")," method. Note that both method has ",(0,o.kt)("inlineCode",{parentName:"p"},"shopId")," parameter. "),(0,o.kt)("p",null,"By applying authorizer above ",(0,o.kt)("inlineCode",{parentName:"p"},"modify")," method (",(0,o.kt)("inlineCode",{parentName:"p"},"PUT /shops/:shopId"),") only accessible by ",(0,o.kt)("inlineCode",{parentName:"p"},"ShopAdmin")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Staff")," other users will not has access to the method. So does the ",(0,o.kt)("inlineCode",{parentName:"p"},"delete")," method only accessible by ",(0,o.kt)("inlineCode",{parentName:"p"},"ShopAdmin"),"."))}p.isMDXComponent=!0},5437:function(e,t,n){"use strict";t.Z=n.p+"assets/images/application-lifecycle-2bfeacf5788605df57e819bb6b1d4aff.png"},5095:function(e,t,n){"use strict";t.Z=n.p+"assets/images/middleware-pipeline-baba5f9be794f56a19720e5693840aa2.png"}}]);