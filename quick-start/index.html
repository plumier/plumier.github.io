<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Plumier Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Plumier Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Plumier" href="/opensearch.xml"><title data-react-helmet="true">Quick Start | Plumier</title><meta data-react-helmet="true" property="og:url" content="https://plumierjs.com/quick-start"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Quick Start | Plumier"><meta data-react-helmet="true" name="description" content="This tutorial will walk you through creating a Restful API managing a Todo data with MySQL database, first we will learn about how to create a Plumier project, then we will learn how to create CRUD API using generic controller then finally we add authorization to protect the data."><meta data-react-helmet="true" property="og:description" content="This tutorial will walk you through creating a Restful API managing a Todo data with MySQL database, first we will learn about how to create a Plumier project, then we will learn how to create CRUD API using generic controller then finally we add authorization to protect the data."><link data-react-helmet="true" rel="shortcut icon" href="/img/plumier.png"><link data-react-helmet="true" rel="canonical" href="https://plumierjs.com/quick-start"><link data-react-helmet="true" rel="alternate" href="https://plumierjs.com/quick-start" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://plumierjs.com/quick-start" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.d15cea6a.css">
<link rel="preload" href="/assets/js/runtime~main.49a208d8.js" as="script">
<link rel="preload" href="/assets/js/main.7996d9fe.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_2vEk">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_rQcN"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/plumier.png" alt="Plumier logo" class="themedImage_2dpp themedImage--light_2yWi navbar__logo"><img src="/img/plumier.png" alt="Plumier logo" class="themedImage_2dpp themedImage--dark_2O_X navbar__logo"><strong class="navbar__title">Plumier</strong></a><a class="navbar__item navbar__link" href="/plumier-in-five-minutes">Docs</a><a href="https://github.com/plumier/examples" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Examples</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/plumier/plumier" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_2YK8 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_2wcW">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_2wcW">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/plumier.png" alt="Plumier logo" class="themedImage_2dpp themedImage--light_2yWi navbar__logo"><img src="/img/plumier.png" alt="Plumier logo" class="themedImage_2dpp themedImage--dark_2O_X navbar__logo"><strong class="navbar__title">Plumier</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/plumier-in-five-minutes">Docs</a></li><li class="menu__list-item"><a href="https://github.com/plumier/examples" target="_blank" rel="noopener noreferrer" class="menu__link">Examples</a></li><li class="menu__list-item"><a href="https://github.com/plumier/plumier" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_2hm3"><div class="docSidebarContainer_mF8j" role="complementary"><div class="sidebar_AUih sidebarWithHideableNavbar_13bV"><a tabindex="-1" class="sidebarLogo_f7Rp" href="/"><img src="/img/plumier.png" alt="Plumier logo" class="themedImage_2dpp themedImage--light_2yWi"><img src="/img/plumier.png" alt="Plumier logo" class="themedImage_2dpp themedImage--dark_2O_X"><strong>Plumier</strong></a><div class="menu menu--responsive thin-scrollbar menu_16eN"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1r51" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/plumier-in-five-minutes">Plumier in Five Minutes</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/quick-start">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" href="/entry-point">Entry Point</a></li><li class="menu__list-item"><a class="menu__link" href="/controller">Controller</a></li><li class="menu__list-item"><a class="menu__link" href="/security">Security</a></li><li class="menu__list-item"><a class="menu__link" href="/generic-controller">Generic Controller</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Data Access</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/typeorm-helper">TypeORM Helper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mongoose-helper">Mongoose Helper</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/query-parser">Query Parser</a></li><li class="menu__list-item"><a class="menu__link" href="/swagger">Swagger</a></li><li class="menu__list-item"><a class="menu__link" href="/social-login">Social Media Login</a></li><li class="menu__list-item"><a class="menu__link" href="/serve-static">Serve Static Files</a></li><li class="menu__list-item"><a class="menu__link" href="/file-upload">File Upload</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/routing">Routing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/validation">Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/middleware">Middleware</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/facility">Facility</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/default-environment-variable">Default Environment Variable</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/extend">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/reflection-basic">Reflection Fundamentals</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/metaprogramming">Metaprogramming</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/custom-parameter-binding">Custom Parameter Binding</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/custom-validator">Custom Validator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/custom-dependency-resolver">Custom Dependency Resolver</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/custom-route-generator">Custom Route Generator</a></li></ul></li></ul></div></div></div><main class="docMainContainer_luF8"><div class="container padding-vert--lg docItemWrapper_12Bq"><div class="row"><div class="col docItemCol_1cpl"><div class="docItemContainer_1YW1"><article><header><h1 class="docTitle_eZEF">Quick Start</h1></header><div class="markdown"><p>This tutorial will walk you through creating a Restful API managing a Todo data with MySQL database, first we will learn about how to create a Plumier project, then we will learn how to create CRUD API using generic controller then finally we add authorization to protect the data.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="software-requirements"></a>Software Requirements<a class="hash-link" href="#software-requirements" title="Direct link to heading">#</a></h2><p>To be able to follow this example you need some software installed in your computer.</p><ul><li><a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer">Node.js</a> v10 or newer </li><li>Any terminal app</li><li>Any text editor, in this example using VSCode</li><li>MySQL database </li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="init-project"></a>Init Project<a class="hash-link" href="#init-project" title="Direct link to heading">#</a></h2><p>To get started we need to download <a href="https://github.com/plumier/starters/tree/master/rest-api-typeorm" target="_blank" rel="noopener noreferrer">TypeORM Rest API project starters</a> from GitHub repository. In this example we will use <a href="https://www.npmjs.com/package/degit" target="_blank" rel="noopener noreferrer">Degit</a> to download it. </p><p>Execute commands below in your terminal to download the project starter</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ sh"><div tabindex="0" class="prism-code language-sh codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npx degit plumier/starters/rest-api-typeorm todo-api</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Above command will download Degit locally then download Plumier TypeORM Rest API project starter into <code>todo-api</code> directory. </p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>If you having problem executing <code>npx</code> you can manually install Degit globally</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ sh"><div tabindex="0" class="prism-code language-sh codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npm i -g degit </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Then followed by executing Degit manually like below</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ sh"><div tabindex="0" class="prism-code language-sh codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">degit plumier/starters/rest-api-typeorm todo-api</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div></div></div><p>Enter to the project directory by executing command below</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cd todo-api</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Install package dependencies by executing command below </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ sh"><div tabindex="0" class="prism-code language-sh codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npm install</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="project-starter-file-structure"></a>Project Starter File Structure<a class="hash-link" href="#project-starter-file-structure" title="Direct link to heading">#</a></h2><p>Open the project directory using your favorite text editor or IDE, its recommended to use VSCode to easily follow this tutorial. </p><p><img alt="project structure" src="/assets/images/project-structure-501cdd62d051b2d7a6c084ffd2932633.png"></p><p>Project starter shipped with a user management and security functionality setup to secure the API. Spent some time to read the <code>user-and-security.md</code> doc to get understanding on how the user management and security setup works.</p><p>Project starter separate files per resource under <code>src/api</code> directory, each file must follow the naming convention.</p><ul><li>File ends with <code>-controller.ts</code> contains codes for controller.</li><li>File ends with <code>-entity.ts</code> contains entities or first class entity.</li><li>File ends with <code>-policy.ts</code> contains authorization policy logic.</li></ul><p>All file stays in <code>_shared</code> directory intended to be shared among the sibling directories.</p><p>You can change those behavior on Plumier application bootstrap on <code>app.ts</code> file. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="running-the-project"></a>Running The Project<a class="hash-link" href="#running-the-project" title="Direct link to heading">#</a></h2><p>After all dependencies installed then it should be good to go, but before we start codding we need to provide required environment variable to make the project work correctly.</p><p>Rename the <code>.env-example</code> file into <code>.env</code> file, then execute command below to run the project</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npm run debug</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>If you are follow step above correctly then above code will print message indicating it serve CRUD user API like below </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; rest-api-typeorm@1.0.0 debug todo-api</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; ts-node-dev --inspect -- src/index</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[INFO] 04:38:03 ts-node-dev ver. 1.1.1 (using ts-node ver. 9.1.1, typescript ver. 4.1.3)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Debugger listening on ws://127.0.0.1:9229/d91c5d70-332a-4880-bf63-aa3c880115b6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">For help, see: https://nodejs.org/en/docs/inspector</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Route Analysis Report</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. AuthController.login(email, password)    -&gt; Public        POST   /auth/login</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. AuthController.refresh(user)             -&gt; RefreshToken  POST   /auth/refresh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. AuthController.logout()                  -&gt; Private       GET    /auth/logout</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4. TypeORMControllerGeneric.list            -&gt; Admin         GET    /users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">5. TypeORMControllerGeneric.save(data, ctx) -&gt; Public        POST   /users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">6. TypeORMControllerGeneric.get             -&gt; ResourceOwner GET    /users/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">7. TypeORMControllerGeneric.modify          -&gt; ResourceOwner PATCH  /users/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">8. TypeORMControllerGeneric.replace         -&gt; ResourceOwner PUT    /users/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">9. TypeORMControllerGeneric.delete(id, ctx) -&gt; ResourceOwner DELETE /users/:id</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Above is the route analysis report created by Plumier route generator system, it prints generated routes from controllers and generic controllers during the generation process, it may print issues on each route if occur.</p><p>If you see above routes, there are two resources currently hosted that is <code>/auth</code> and <code>/users</code>. Auth resource used to handle authentication its put on the <code>api/auth/auth-controller.ts</code> file. Its handled by a common controller, on the left of the route analysis report you can see the action handles the route <code>AuthController.login(email, password)</code>. </p><p>The User resource is quite different, you can see the source code in <code>api/users/user-entity.ts</code> it uses first class entity with <code>@genericController()</code> decorator which means its handled by a generic controller. You can see also on the left of the route analysis report the action handled the routes uses <code>TypeORMControllerGeneric</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="setup-mysql-connection"></a>Setup MySQL Connection<a class="hash-link" href="#setup-mysql-connection" title="Direct link to heading">#</a></h2><p>By default project starter uses SQLite database driver, in this example we will install MySQL database and change the appropriate connection string on the <code>.env</code> file. Execute command below on your terminal app.</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npm install --save mysql </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Above will install mysql driver and modify the <code>package.json</code> file, you may uninstall the <code>sqlite3</code> driver by removing it on the <code>package.json</code> file, but its not necessary need to do on this example.</p><p>Create MySQL database named <code>todo</code> with any MySQL client and change the TypeORM configuration section on <code>.env</code> like below </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># TypeORM configurations</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">TYPEORM_URL = &quot;mysql://&lt;username&gt;:&lt;password&gt;@localhost/todo&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">TYPEORM_ENTITIES = &quot;src/api/**/*-*(entity|controller).*(ts|js)&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">TYPEORM_SYNCHRONIZE = true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">TYPEORM_LOGGING = false</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Restart the API which previously running by pressing <code>ctl+c</code> on the terminal app then re-run the command below to restart it.</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npm run debug</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="add-root-path"></a>Add Root Path<a class="hash-link" href="#add-root-path" title="Direct link to heading">#</a></h2><p>On this step we will add API version by adding root path <code>/api/v1</code> for all generated routes. To do that we will need to configure the Plumier application bootstrap.</p><p>Open the <code>src/app.ts</code> file and locate the <code>WebApiFacility</code> add configuration <code>rootPath: &quot;/api/v1&quot;</code> on the parameter, so the code will be like below. </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ typescript"><div tabindex="0" class="prism-code language-typescript codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">WebApiFacility</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> rootPath</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/api/v1&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Save the file and see the log on terminal app will show our change like below.</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Route Analysis Report</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. AuthController.login(email, password)    -&gt; Public        POST   /api/v1/auth/login</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. AuthController.refresh(user)             -&gt; RefreshToken  POST   /api/v1/auth/refresh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. AuthController.logout()                  -&gt; Private       GET    /api/v1/auth/logout</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4. TypeORMControllerGeneric.list            -&gt; Admin         GET    /api/v1/users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">5. TypeORMControllerGeneric.save(data, ctx) -&gt; Public        POST   /api/v1/users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">6. TypeORMControllerGeneric.get             -&gt; ResourceOwner GET    /api/v1/users/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">7. TypeORMControllerGeneric.modify          -&gt; ResourceOwner PATCH  /api/v1/users/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">8. TypeORMControllerGeneric.replace         -&gt; ResourceOwner PUT    /api/v1/users/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">9. TypeORMControllerGeneric.delete(id, ctx) -&gt; ResourceOwner DELETE /api/v1/users/:id</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Above showing that now all the routes path started with <code>/api/v1</code> with all the routes generated.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="testing-api-using-swagger"></a>Testing API Using Swagger<a class="hash-link" href="#testing-api-using-swagger" title="Direct link to heading">#</a></h2><p>The project starter comes with swagger ui under <code>http://localhost:8000/swagger</code> we can use it to test the User API provided by the project starter. </p><p>Navigate to the <code>POST /api/v1/users</code> and provide the email, name and password like below</p><p><img alt="add user" src="/assets/images/swagger-user-post-41095257591ec581cd5f6271b04e8393.png"></p><p>Above process will return the ID of the inserted record <code>{ id: 1 }</code>. Next we can try the login function by navigating to the <code>POST /auth/login</code> endpoint and provide email and password that we entered previously. </p><p><img alt="login" src="/assets/images/swagger-login-df4f38d992cce5d307778969deb2c07c.png"></p><p>Above will returned two JWT tokens <code>{ token, refreshToken }</code> and also writes the Authorization cookie to the browser. Now you are login to the system, try play around accessing private resource such as <code>GET /api/v1/users/{id}</code> like below. </p><p><img alt="get user by id" src="/assets/images/swagger-user-get-by-id-127aebcaeb7651269d5a8c10a86c6aaf.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="add-todo-api"></a>Add Todo API<a class="hash-link" href="#add-todo-api" title="Direct link to heading">#</a></h2><p>Now we&#x27;re ready for codding, we will add Todo resource to the application using a generic controller. Create new directory under <code>/src/api</code> named <code>todo</code> and create new file named <code>todo-entity.ts</code> and copy paste code below. </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ typescript"><div tabindex="0" class="prism-code language-typescript codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> authorize</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> bind</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> preSave</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> route</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> val </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;plumier&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">BaseEntity</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">Column</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">Entity</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">ManyToOne</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;typeorm&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">LoginUser</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../_shared/login-user&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">User</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../user/user-entity&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@</span><span class="token function" style="color:rgb(130, 170, 255)">genericController</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">c </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">methods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Put&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Patch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Delete&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ResourceOwner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Admin&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Entity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">Todo</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">extends</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">BaseEntity</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @val</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">required</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Column</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    message</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Column</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">default</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    completed</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">boolean</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">readonly</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">ManyToOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function" style="color:rgb(130, 170, 255)">preSave</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;post&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">setUser</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">@bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> user</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">LoginUser</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">user</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">User</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> id</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">userId</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>If you are a TypeORM user you may a bit familiar with above code. Above is a first class entity, its control most API behavior from the entity itself. </p><p><code>@genericController()</code> will inform Plumier that this entity handled by a generic controller. Provide simple configuration to set that the Todo data only can be modified (<code>PUT</code>, <code>PATCH</code>, <code>DELETE</code>) by the <code>ResourceOwner</code> (user created the todo) and by the <code>Admin</code> of the API. </p><p>We apply validation on the <code>message</code> property, tells Plumier that this field is required. Plumier will automatically response 422 when this field value does not provided.</p><p>We add <code>@authorize.readonly()</code> on the <code>user</code> property because its value automatically populated using <code>preSave</code> request hook. </p><p>On <code>preSave</code> request hook we bind the current login user into the <code>user</code> parameter and populate the <code>user</code> property value. This <code>setUser</code> method will be executed before the entity saved into the database. Note that the <code>post</code> parameter provided means this method only executed on POST method, other than that it will never executed.</p><p>Save the file and see if the route analysis report showing result like below.</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">..... other routes ....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4. TypeORMControllerGeneric.list            -&gt; Private             GET    /api/v1/todos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">5. TypeORMControllerGeneric.save(data, ctx) -&gt; Private             POST   /api/v1/todos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">6. TypeORMControllerGeneric.get             -&gt; Private             GET    /api/v1/todos/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">7. TypeORMControllerGeneric.modify          -&gt; ResourceOwner|Admin PATCH  /api/v1/todos/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">8. TypeORMControllerGeneric.replace         -&gt; ResourceOwner|Admin PUT    /api/v1/todos/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">9. TypeORMControllerGeneric.delete(id, ctx) -&gt; ResourceOwner|Admin DELETE /api/v1/todos/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">..... other routes ....</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Now we ready to test our Todo API, go back to swagger ui and find out the <code>POST /api/v1/todos</code> endpoint and execute with data like below.</p><p><img alt="insert todo" src="/assets/images/swagger-todo-post-416117ff300f9e26416d32c704bbd023.png"></p><p>Above will return the new inserted record ID <code>{ id: 1 }</code> indicate that our API already work properly. You can play around with other API such as <code>GET /api/v1/todos/{id}</code> like below. </p><p><img alt="get by id" src="/assets/images/swagger-todo-get-by-id-85d700b50ac246b828b889908a3dd57f.png"></p><p>Like you see above the <code>user</code> property of the Todo entity populated properly with the current login user. Next step we will secure our API so it only can be modify and deleted by the owner of the Todo.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="todo-resourceowner-definition"></a>Todo ResourceOwner Definition<a class="hash-link" href="#todo-resourceowner-definition" title="Direct link to heading">#</a></h2><p>If you look at the <code>/api/user/user-policy.ts</code> file you will see how the <code>ResourceOwner</code> auth policy defined using <code>entityPolicy</code>. Entity policy works only to specific entity defined, its logical since definition of <code>ResourceOwner</code> may vary among entity based on the data structure. In this step will will created definition for <code>ResourceOwner</code> specifically for Todo entity. </p><p>Create a new file under <code>/api/todo</code> named <code>todo-policy.ts</code> and copy paste code below. </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ typescript"><div tabindex="0" class="prism-code language-typescript codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> entityPolicy </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;plumier&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> getManager </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;typeorm&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Todo</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./todo-entity&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">entityPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Todo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">register</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ResourceOwner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> repo </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">getManager</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Todo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> todo </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> repo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> relations</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cache</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">user</span><span class="token operator" style="color:rgb(137, 221, 255)">?.</span><span class="token plain">userId </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> todo</span><span class="token operator" style="color:rgb(137, 221, 255)">?.</span><span class="token plain">user</span><span class="token operator" style="color:rgb(137, 221, 255)">?.</span><span class="token plain">id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Above is the definition of <code>ResourceOwner</code> for Todo and provide a callback function how we define the owner of the Todo data like this <code>ctx.user.userId === todo.user.id</code>. This callback function will be called several time: </p><ul><li>During route authorization evaluation, to check if user authorized to access the route.</li><li>During parameter authorization evaluation, to check if user authorized to set entity property.</li><li>During response authorization evaluation, to remove some property that not authorized to a user.</li></ul><p>Based on above behavior, its necessary to cache the query to speed up the process. </p><p>The callback received two parameters the first is the Authorization Context and the second is the ID of the evaluated Todo data. The callback returned <code>true</code> to authorized the user other wise <code>false</code>. </p><p>Now its time to test our auth policy, create another user using <code>POST /api/v1/users</code> API then login using <code>POST /api/v1/login</code>. Then try to delete our last inserted todo using the <code>DELETE /api/v1/todos/{id}</code> like below. </p><p><img alt="delete failed" src="/assets/images/swagger-todo-delete-failed-597a4c4c47a4e0cf678e20e1d3adf89c.png"></p><p>Picture above showing that our auth policy successfully secured the API by returning 401. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="nested-api-for-todo-comment"></a>Nested API for Todo Comment<a class="hash-link" href="#nested-api-for-todo-comment" title="Direct link to heading">#</a></h2><p>We are successfully created an API using a generic controller, next we will learn how to create nested API using nested generic controller. </p><p>Nested API is a restful best practice to provide parent - children API, usually used nested endpoint like <code>/parents/{parentId}/children</code>. </p><p>In this example we will form Todo -&gt; Comment as a parent - children relation, since each Todo can have their own notes. We will provide an API using nested generic controller to do that. </p><p>First we need to define the Comment entity, create a directory under <code>src/api</code> named <code>todo-comment</code>, then create a file named <code>comment-entity.ts</code> then copy paste code below. </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ typescript"><div tabindex="0" class="prism-code language-typescript codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> authorize</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> bind</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> preSave</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> route</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> val </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;plumier&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Column</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">Entity</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">ManyToOne</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;typeorm&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">EntityBase</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../_shared/entity-base&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">LoginUser</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../_shared/login-user&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Todo</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../todo/todo-entity&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">User</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../user/user-entity&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Entity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">Comment</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">extends</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">EntityBase</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @val</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">required</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Column</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    message</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">readonly</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">ManyToOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">readonly</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">ManyToOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">Todo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    todo</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">Todo</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function" style="color:rgb(130, 170, 255)">preSave</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;post&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">setUser</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">@bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> user</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">LoginUser</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">user</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">User</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> id</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">userId</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Above is the Comment entity, the <code>todo</code> entity set to readonly, since its a reverse property to the parent entity it will populated automatically by the generic controller.</p><p>You may notice that it doesn&#x27;t have <code>@genericController()</code> decorator. The most important thing is, nested generic controller require an array relation (one to many or many to many) than we can create the API by providing <code>@genericController()</code> on the relation property. </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ typescript"><div tabindex="0" class="prism-code language-typescript codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Column</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">Entity</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">ManyToOne</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">OneToMany</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;typeorm&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Comment</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../todo-comment/comment-entity&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/** other imports **/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">Todo</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">extends</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">EntityBase</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/** other properties **/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function" style="color:rgb(130, 170, 255)">genericController</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">c </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">methods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Put&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Patch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Delete&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ResourceOwner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Admin&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">OneToMany</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">Comment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> x </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">todo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    comments</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">Comment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Above showing that we modify our current Todo entity by adding a one to many relation to the comment entity. You can see also we add <code>@genericController()</code> decorator above the <code>comments</code> property means its will be handled by a nested generic controller.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Decorating one to many property with <code>@genericController()</code> may make the code less cleaner, since the controller configuration stays in <code>todo</code> directory instead of the <code>todo-comment</code> directory. Alternatively you can put <code>@genericController()</code> above the inverse property of the Comment entity which is <code>user</code> property.</p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ typescript"><div tabindex="0" class="prism-code language-typescript codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">@</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Entity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">Comment</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">extends</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">EntityBase</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function" style="color:rgb(130, 170, 255)">genericController</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">c </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">methods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Put&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Patch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Delete&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ResourceOwner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Admin&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="font-style:italic">readonly</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">ManyToOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    user</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div></div></div><p>Next you can save the file and see the route analysis report like below. </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_"><div tabindex="0" class="prism-code language-undefined codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">..... other routes ....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1.  TypeORMNested...eneric.list           -&gt; Private             GET    /api/v1/todos/:pid/comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2.  TypeORMNested...eneric.save           -&gt; Private             POST   /api/v1/todos/:pid/comments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3.  TypeORMNested...eneric.get            -&gt; Private             GET    /api/v1/todos/:pid/comments/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4.  TypeORMNested...eneric.modify         -&gt; ResourceOwner|Admin PATCH  /api/v1/todos/:pid/comments/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">5.  TypeORMNested...eneric.replace        -&gt; ResourceOwner|Admin PUT    /api/v1/todos/:pid/comments/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">6.  TypeORMNested...eneric.delete         -&gt; ResourceOwner|Admin DELETE /api/v1/todos/:pid/comments/:id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">..... other routes ....</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>You see that the routes now handled by <code>TypeORMNestedControllerGeneric</code> and the endpoints is <code>/api/v1/todos/:pid/comments</code>. We used the Todo Comment API endpoints by providing the Todo ID like this <code>/api/v1/todos/1/comments</code>. </p><p>We can test our new API using swagger like the picture below. </p><p><img alt="add comment" src="/assets/images/swagger-comment-post-9366e4f83b14a74a88521632b5a009ce.png"></p><p>When successfully added a comment, try adding more comments to the Todo and then show all the inserted comments using <code>GET /api/v1/todos/1/comments</code> like picture below.</p><p><img alt="get all comments" src="/assets/images/swagger-comment-get-all-820647c6db39078236f21439aaf4c264.png"></p><p>Try experimenting with filter and select parameter and see the change reflected in the response result. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="comment-resource-owner"></a>Comment Resource Owner<a class="hash-link" href="#comment-resource-owner" title="Direct link to heading">#</a></h2><p>The last step, we need to define <code>ResourceOwner</code> for the Comment entity, the step is exactly the same like before. Create a new file named <code>comment-policy.ts</code> then copy paste code below. </p><div class="codeBlockContainer_2jEK"><div class="codeBlockContent_115_ typescript"><div tabindex="0" class="prism-code language-typescript codeBlock_1XLE thin-scrollbar"><div class="codeBlockLines_2ir3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> entityPolicy </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;plumier&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> getManager </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;typeorm&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Comment</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./comment-entity&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">entityPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Comment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">register</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ResourceOwner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> repo </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">getManager</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getRepository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Comment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> comment </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> repo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> relations</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cache</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">user</span><span class="token operator" style="color:rgb(137, 221, 255)">?.</span><span class="token plain">userId </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> comment</span><span class="token operator" style="color:rgb(137, 221, 255)">?.</span><span class="token plain">user</span><span class="token operator" style="color:rgb(137, 221, 255)">?.</span><span class="token plain">id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_3nrq">Copy</button></div></div><p>Code above is mostly the same as before. We can test our auth policy by using other user to delete the comment like picture below.</p><p><img alt="delete failed" src="/assets/images/swagger-comment-delete-failed-336adf00a735bc52a1d042c68e6fb972.png"></p><p>Above showing that other user failed to delete the comment by returned 401. You can play around with other API and see how the its reflect in the response. </p><p>Thats it! this is the end of the get started tutorial, don&#x27;t forget that Plumier has more feature for you to explore.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/plumier/plumier/edit/master/docs/docusaurus/docs/Quick-Start.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2nOl" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/plumier-in-five-minutes"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Plumier in Five Minutes</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/entry-point"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Entry Point Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2Tf- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#software-requirements" class="table-of-contents__link">Software Requirements</a></li><li><a href="#init-project" class="table-of-contents__link">Init Project</a></li><li><a href="#project-starter-file-structure" class="table-of-contents__link">Project Starter File Structure</a></li><li><a href="#running-the-project" class="table-of-contents__link">Running The Project</a></li><li><a href="#setup-mysql-connection" class="table-of-contents__link">Setup MySQL Connection</a></li><li><a href="#add-root-path" class="table-of-contents__link">Add Root Path</a></li><li><a href="#testing-api-using-swagger" class="table-of-contents__link">Testing API Using Swagger</a></li><li><a href="#add-todo-api" class="table-of-contents__link">Add Todo API</a></li><li><a href="#todo-resourceowner-definition" class="table-of-contents__link">Todo ResourceOwner Definition</a></li><li><a href="#nested-api-for-todo-comment" class="table-of-contents__link">Nested API for Todo Comment</a></li><li><a href="#comment-resource-owner" class="table-of-contents__link">Comment Resource Owner</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/plumier-in-five-minutes">Fundamentals</a></li><li class="footer__item"><a class="footer__link-item" href="/quick-start">Plumier in Five Minutes</a></li><li class="footer__item"><a class="footer__link-item" href="/extend">Extending Plumier</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/plumier" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/plumier/plumier" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Plumier.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.49a208d8.js"></script>
<script src="/assets/js/main.7996d9fe.js"></script>
</body>
</html>