<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Create Local Authentication · Plumier</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&gt; **Info**  "/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Create Local Authentication · Plumier"/><meta property="og:type" content="website"/><meta property="og:url" content="https://plumierjs.com/"/><meta property="og:description" content="&gt; **Info**  "/><meta property="og:image" content="https://plumierjs.com/img/plumier-black.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://plumierjs.com/img/plumier-black.png"/><link rel="shortcut icon" href="/img/plumier.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/plumier.svg" alt="Plumier"/><h2 class="headerTitleWithLogo">Plumier</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/overview" target="_self">Docs</a></li><li class="siteNavGroupActive"><a href="/docs/tutorials/basic-sql/get-started" target="_self">Tutorials</a></li><li class=""><a href="https://github.com/plumier/plumier" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>SQL Restful API</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">SQL Restful API<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/get-started">Get Started</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/create-domain">Create Domain Model</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/create-migration">Create DB Migration</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/create-restful-api">Create Restful API</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/debugging">Debugging</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/create-custom-validation">Create Custom Validation</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/tutorials/basic-sql/create-local-authentication">Create Local Authentication</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/securing-routes">Securing Routes</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/securing-domain">Securing Domain Models</a></li><li class="navListItem"><a class="navItem" href="/docs/tutorials/basic-sql/deployment">Deployment</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Create Local Authentication</h1></header><article><div><span><blockquote>
<p><strong>Info</strong>  <br>
This is the seventh part of 10 steps tutorial on creating basic SQL restful API. Check navigation to navigate to other steps.</p>
</blockquote>
<p>Our API now run as expected, we will add token based authentication and authorization function to secure routes to restrict access to some users.</p>
<h2><a class="anchor" aria-hidden="true" id="install-packages"></a><a href="#install-packages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install Packages</h2>
<p>Start by installing required packages used to create token based authentication. Open Visual Studio Code integrated terminal and execute command below</p>
<pre><code class="hljs css language-bash">$ yarn add @plumier/jwt jsonwebtoken @types/jsonwebtoken
</code></pre>
<p>Above command will install <code>@plumier/jwt</code> that required for JWT authorization and <code>jsonwebtoken</code> package and its typing that will be used to sign JWT token.</p>
<h2><a class="anchor" aria-hidden="true" id="add-jwt-secret-configuration"></a><a href="#add-jwt-secret-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add JWT Secret Configuration</h2>
<p>Next we need to add new field on the <code>.env</code> configuration called <code>JWT_SECRET</code> like below</p>
<pre><code class="hljs css language-bash">JWT_SECRET=<span class="hljs-string">"&lt;secret string&gt;"</span>
</code></pre>
<p>Secret string can be any string, or can be generated using <a href="https://passwordsgenerator.net/">online password generator</a>.</p>
<p>Add type information on the <code>config.d.ts</code> file for intellisense</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> NodeJS {
    <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> ProcessEnv {
        PORT: <span class="hljs-built_in">string</span>
        DB_URI: <span class="hljs-built_in">string</span>
        JWT_SECRET:<span class="hljs-built_in">string</span> <span class="hljs-comment">//&lt;--- add this</span>
    }
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="enable-facility"></a><a href="#enable-facility" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enable Facility</h2>
<p>By default authorization functionalities is not enabled, we need to setup <code>JwtAuthFacility</code> from <code>@plumier/jwt</code> package into the Plumier application startup. Navigate to <code>src/app.ts</code> file and set <code>JwtAuthFacility</code> like below</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">import</span> Koa <span class="hljs-keyword">from</span> <span class="hljs-string">"koa"</span>
<span class="hljs-keyword">import</span> Plumier, { Configuration, WebApiFacility } <span class="hljs-keyword">from</span> <span class="hljs-string">"plumier"</span>
<span class="hljs-keyword">import</span> { JwtAuthFacility } <span class="hljs-keyword">from</span> <span class="hljs-string">"@plumier/jwt"</span>

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createApp</span>(<span class="hljs-params">config?: Partial&lt;Configuration&gt;</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">Koa</span>&gt; </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Plumier()
        .set(config || {})
        .set(<span class="hljs-keyword">new</span> WebApiFacility())
        .set(<span class="hljs-keyword">new</span> JwtAuthFacility({ secret: process.env.JWT_SECRET })) <span class="hljs-comment">// &lt;--- add this line</span>
        .initialize()
}
</code></pre>
<p>Above code showing that we enabled the JWT authorization and provided the JWT secret, refer to <a href="/docs/refs/authorization">this documentation</a> for more information about the facility</p>
<h2><a class="anchor" aria-hidden="true" id="add-login-user-domain"></a><a href="#add-login-user-domain" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add Login User Domain</h2>
<p>We will need to define another domain to represent a login user. Navigate to <code>model/domains.ts</code> and add code below at the end of the file.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-meta">@domain</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> LoginUser {
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> userId:<span class="hljs-built_in">number</span>,
        <span class="hljs-keyword">public</span> role: UserRole
    </span>){}
}
</code></pre>
<p>Above domain will represent the login user or user claim that will we signed as JWT token.</p>
<p><code>role</code> field is required when using <code>JwtAuthFacility</code> it should be of type of <code>string</code>. Or you can provide <code>string[]</code> for hierarchical authorization.</p>
<h2><a class="anchor" aria-hidden="true" id="add-login-function"></a><a href="#add-login-function" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add Login Function</h2>
<p>We are ready now to program the login controller. We defined login function is not part of API functionalities so we will put the login controller in the root controller directory. Create new file name <code>auth-controller.ts</code> inside <code>controller</code> directory and add the following code</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">import</span> bcrypt <span class="hljs-keyword">from</span> <span class="hljs-string">"bcrypt"</span>
<span class="hljs-keyword">import</span> { sign } <span class="hljs-keyword">from</span> <span class="hljs-string">"jsonwebtoken"</span>
<span class="hljs-keyword">import</span> { HttpStatusError, route, authorize } <span class="hljs-keyword">from</span> <span class="hljs-string">"plumier"</span>

<span class="hljs-keyword">import</span> { db } <span class="hljs-keyword">from</span> <span class="hljs-string">"../model/db"</span>
<span class="hljs-keyword">import</span> { LoginUser, User } <span class="hljs-keyword">from</span> <span class="hljs-string">"../model/domain"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AuthController {
    <span class="hljs-meta">@authorize</span>.public()
    <span class="hljs-meta">@route</span>.post()
    <span class="hljs-keyword">async</span> login(email: <span class="hljs-built_in">string</span>, password: <span class="hljs-built_in">string</span>) {
        <span class="hljs-keyword">const</span> user: User | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">await</span> db(<span class="hljs-string">"User"</span>).where({ email }).first()
        <span class="hljs-keyword">if</span> (user &amp;&amp; <span class="hljs-keyword">await</span> bcrypt.compare(password, user.password)) {
            <span class="hljs-keyword">const</span> token = sign(&lt;LoginUser&gt;{ userId: user.id, role: user.role }, process.env.JWT_SECRET)
            <span class="hljs-keyword">return</span> { token }
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> HttpStatusError(<span class="hljs-number">403</span>, <span class="hljs-string">"Invalid username or password"</span>)
    }
}
</code></pre>
<p>Controller above will generated into <code>POST /auth/login</code> route. By default when authorization enabled all route will become secured, means only authenticated user can access routes. <code>@authorize.public()</code> above the <code>login</code> method will make <code>/auth/login</code> accessible by public.</p>
<p>The logic is quite simple, if the provided password match with the saved hash password then a JWT token without token expiration will be returned. If the password doesn't match then it will return Forbidden error with http status 403.</p>
<h2><a class="anchor" aria-hidden="true" id="testing-login-function"></a><a href="#testing-login-function" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Testing Login Function</h2>
<p>Our authentication route is ready to test, execute command below from Visual Studio Code integrated terminal</p>
<pre><code class="hljs css language-bash">$ http :8000/auth/login email=admin@todo.app password=123456
</code></pre>
<p>Note that <code>admin@todo.app</code> is user that we add during migration using Knex.js seeds. Above command will response jwt token like below</p>
<pre><code class="hljs css language-bash">HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 152
Content-Type: application/json; charset=utf-8
Date: Sun, 10 Mar 2019 03:48:54 GMT
Vary: Origin

{
    <span class="hljs-string">"token"</span>: <span class="hljs-string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInJvbGUiOiJBZG1pbiIsImlhdCI6MTU1MjE4OTczNH0.7kzqgsi1ywRzGCQTTn9vYKGS5sYvPGlqF78YUcUbmMY"</span>
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="add-todo-based-on-login-user"></a><a href="#add-todo-based-on-login-user" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add Todo Based On Login User</h2>
<p>Previously when adding todos we specify <code>userId</code> manually. Now we have current login user operating the application, we will modify the logic that adding todo will automatically associated with the login user.</p>
<p>Navigate to <code>todos-controller.ts</code> and modify <code>save</code> method like below</p>
<pre><code class="hljs css language-typescript"><span class="hljs-comment">//add this import above your controller</span>
<span class="hljs-comment">//import { bind } from "plumier"</span>

<span class="hljs-meta">@route</span>.post(<span class="hljs-string">""</span>)
save(data: Todo, <span class="hljs-meta">@bind</span>.user() user: LoginUser) {
    <span class="hljs-keyword">return</span> db(<span class="hljs-string">"Todo"</span>).insert(&lt;Todo&gt;{ ...data, userId: user.userId })
}
</code></pre>
<p>Above code showing that we doing decorator binding <code>@bind.user()</code> to the <code>user</code> parameter, using this snippet <code>user</code> parameter will automatically populated with current login domain during request.</p>
<p>Test above modification by executing command below in Visual Studio Code integrated terminal</p>
<pre><code class="hljs css language-bash">$ http POST :8000/api/v1/todos Authorization:<span class="hljs-string">"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInJvbGUiOiJBZG1pbiIsImlhdCI6MTU1MjE4OTczNH0.7kzqgsi1ywRzGCQTTn9vYKGS5sYvPGlqF78YUcUbmMY"</span> todo=<span class="hljs-string">"Buy some other milks"</span>
</code></pre>
<p>Command above showing that we don't need to specify <code>userId</code> anymore. We also specify <code>Bearer</code> token that we got from last login into the <code>Authorization</code> header on the request.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/tutorials/basic-sql/create-custom-validation"><span class="arrow-prev">← </span><span>Create Custom Validation</span></a><a class="docs-next button" href="/docs/tutorials/basic-sql/securing-routes"><span>Securing Routes</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#install-packages">Install Packages</a></li><li><a href="#add-jwt-secret-configuration">Add JWT Secret Configuration</a></li><li><a href="#enable-facility">Enable Facility</a></li><li><a href="#add-login-user-domain">Add Login User Domain</a></li><li><a href="#add-login-function">Add Login Function</a></li><li><a href="#testing-login-function">Testing Login Function</a></li><li><a href="#add-todo-based-on-login-user">Add Todo Based On Login User</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2020 Plumier</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'cc5032f20c325b27c07de03fe7078651',
                indexName: 'plumierjs',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>