<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Middleware · Plumier</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;blockquote&gt;
&lt;p&gt;Plumier supports Koa middleware out of the box, you can use any existing Koa middleware&lt;/p&gt;
&lt;/blockquote&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Middleware · Plumier"/><meta property="og:type" content="website"/><meta property="og:url" content="https://plumierjs.com/"/><meta property="og:description" content="&lt;blockquote&gt;
&lt;p&gt;Plumier supports Koa middleware out of the box, you can use any existing Koa middleware&lt;/p&gt;
&lt;/blockquote&gt;
"/><meta property="og:image" content="https://plumierjs.com/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://plumierjs.com/img/docusaurus.png"/><link rel="shortcut icon" href="/img/plumier.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/plumier.svg" alt="Plumier"/><h2 class="headerTitleWithLogo">Plumier</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/overview" target="_self">Docs</a></li><li class=""><a href="/docs/tutorials/basic-sql/get-started" target="_self">Tutorials</a></li><li class=""><a href="https://github.com/plumier/plumier" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Fundamentals</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Fundamentals<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/overview">Plumier In Five Minutes</a></li><li class="navListItem"><a class="navItem" href="/docs/entry-point">Application Startup</a></li><li class="navListItem"><a class="navItem" href="/docs/controller">Controller</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/middleware">Middleware</a></li><li class="navListItem"><a class="navItem" href="/docs/facility">Facility</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">References<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/refs/route">Route Cheat Sheet</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/parameter-binding">Parameter Binding</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/validation">Validation</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/converters">Converters</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/authorization">Authorization</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/serve-static">Serve Static Files</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/file-upload">File Upload</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/mongoose-helper">Mongoose Helper</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/static-analysis">Static Analysis</a></li><li class="navListItem"><a class="navItem" href="/docs/refs/testing-tips">Testing Tips</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Extending<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/extends/custom-parameter-binding">Custom Parameter Binding</a></li><li class="navListItem"><a class="navItem" href="/docs/extends/custom-converter">Custom Converter</a></li><li class="navListItem"><a class="navItem" href="/docs/extends/custom-validator">Custom Validator</a></li><li class="navListItem"><a class="navItem" href="/docs/extends/custom-authorization">Custom Authorization</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Middleware</h1></header><article><div><span><blockquote>
<p>Plumier supports Koa middleware out of the box, you can use any existing Koa middleware</p>
</blockquote>
<p>Plumier middleware works exactly like Koa middleware, it executed in a stack-like order and has full control of the next middleware.</p>
<p>The different between Plumier middleware and Koa middleware is Plumier middleware is a stateless class which has a method that act like pure function. It doesn't mutate things but returns value. With this behavior Plumier middleware relatively easy to unit test in isolation.</p>
<h2><a class="anchor" aria-hidden="true" id="signature"></a><a href="#signature" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Signature</h2>
<p>Plumier middleware is a class that implements <code>Middleware</code> interface. The signature of <code>Middleware</code> interface is like below:</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> Middleware {
    execute(next: Readonly&lt;Invocation&gt;): <span class="hljs-built_in">Promise</span>&lt;ActionResult&gt;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> Invocation {
    context: Readonly&lt;Context&gt;
    proceed(): <span class="hljs-built_in">Promise</span>&lt;ActionResult&gt;
}

</code></pre>
<p>Middleware has one parameter <code>next</code> which is an instance of <code>Invocation</code> object to proceed the next middleware.
Middleware must return a promised <code>ActionResult</code>, you can return result of the invocation which mean its return
result of previous middleware (its possibly the result of the action if the next middlewares doesn't modify the result).
You can also return modified version of action result or a brand new action result. You can also throw an error from
inside of middleware, the default error handler will handle it properly.</p>
<h2><a class="anchor" aria-hidden="true" id="develop-your-own-middleware"></a><a href="#develop-your-own-middleware" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Develop Your Own Middleware</h2>
<p>To create a plumier middleware is as easy as Koa middleware, The idea is the same but simpler. The most basic middleware that does nothing is like below:</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">class</span> BasicMiddleware <span class="hljs-keyword">implements</span> Middleware {
    execute(next: Readonly&lt;Invocation&gt;): <span class="hljs-built_in">Promise</span>&lt;ActionResult&gt; {
        <span class="hljs-keyword">return</span> next.proceed()
    }
}
</code></pre>
<p>Middleware above only execute the next middleware and pass its result into previous middleware.</p>
<p>More real world example is creating a error handler middleware, For example we need to log all internal error 500
into database for auditing process.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">class</span> BasicMiddleware <span class="hljs-keyword">implements</span> Middleware {
    <span class="hljs-keyword">async</span> execute(next: Readonly&lt;Invocation&gt;): <span class="hljs-built_in">Promise</span>&lt;ActionResult&gt; {
        <span class="hljs-keyword">try</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> next.proceed()
        }
        <span class="hljs-keyword">catch</span> (e){
            <span class="hljs-keyword">if</span>(e instance of HttpStatusError &amp;&amp; e.status === <span class="hljs-number">500</span>){
                <span class="hljs-comment">//save error to db</span>
            }
            <span class="hljs-comment">//just re-throw it and let default error handler handle it</span>
            <span class="hljs-keyword">throw</span> e
        }
    }
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="interception"></a><a href="#interception" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interception</h2>
<p>Middleware has full control of the next middleware, with this behavior we can do interception easily.
There are 3 types of interception: before, after and around.</p>
<h3><a class="anchor" aria-hidden="true" id="intercept-before"></a><a href="#intercept-before" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Intercept Before</h3>
<p>Interception occurs before the next execution proceeded. For example the authorization middleware,
where the interception occur before proceeded.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">class</span> AdminOnlyMiddleware <span class="hljs-keyword">implements</span> Middleware {
    execute(next: Readonly&lt;Invocation&gt;): <span class="hljs-built_in">Promise</span>&lt;ActionResult&gt; {
        <span class="hljs-keyword">if</span>(next.context.state.user.role !== <span class="hljs-string">"Admin"</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> HttpStatusError(<span class="hljs-number">401</span>)
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> next.proceed()
    }
}
</code></pre>
<p>Above code showing that we intercept the process before proceeding to next middleware. If the user role
is not Admin then throw Unauthorized status.</p>
<h3><a class="anchor" aria-hidden="true" id="intercept-after"></a><a href="#intercept-after" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Intercept After</h3>
<p>Interception occurs after the next execution proceeded. For example we need to modify content of the result
based on http status.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">class</span> ModifyResponseMiddleware <span class="hljs-keyword">implements</span> Middleware {
    <span class="hljs-keyword">async</span> execute(next: Readonly&lt;Invocation&gt;): <span class="hljs-built_in">Promise</span>&lt;ActionResult&gt; {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> next.proceed()
        <span class="hljs-keyword">if</span>(result.status === <span class="hljs-number">500</span>){
            <span class="hljs-comment">//do something and return ActionResult</span>
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> result
    }
}
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="intercept-around"></a><a href="#intercept-around" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Intercept Around</h3>
<p>Interception occurs before and after the next execution. For example we need to log the response time of every request.</p>
<pre><code class="hljs css language-typescript">
<span class="hljs-keyword">class</span> ResponseTimeMiddleware <span class="hljs-keyword">implements</span> Middleware {
    <span class="hljs-keyword">async</span> execute(next: Readonly&lt;Invocation&gt;): <span class="hljs-built_in">Promise</span>&lt;ActionResult&gt; {
        <span class="hljs-built_in">console</span>.time(<span class="hljs-string">"Response Time"</span>)
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> next.execute()
        <span class="hljs-built_in">console</span>.timeEnd(<span class="hljs-string">"Response Time"</span>)
        <span class="hljs-keyword">return</span> result
    }
}
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/controller"><span class="arrow-prev">← </span><span>Controller</span></a><a class="docs-next button" href="/docs/facility"><span>Facility</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#signature">Signature</a></li><li><a href="#develop-your-own-middleware">Develop Your Own Middleware</a></li><li><a href="#interception">Interception</a><ul class="toc-headings"><li><a href="#intercept-before">Intercept Before</a></li><li><a href="#intercept-after">Intercept After</a></li><li><a href="#intercept-around">Intercept Around</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2019 Plumier</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'cc5032f20c325b27c07de03fe7078651',
                indexName: 'plumierjs',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>